<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="NEDMORD0120">

	<!-- 신선매입정보변경 -->
	<typeAlias alias="NEDMORD0120VO" type="com.lottemart.epc.edi.order.model.NEDMORD0120VO"/>
	
	<resultMap id="NEDMORD0120VOMap" class="NEDMORD0120VO">
		<result property="prodCd"			column="PROD_CD"			/>	<!-- 상품코드 -->
		<result property="srcmkCd"			column="SRCMK_CD"			/>	<!-- 판매코드 -->
		<result property="prodNm"			column="PROD_NM"			/>	<!-- 상품명 -->
		<result property="prodStd"			column="PROD_STD"			/>	<!-- 상품규격 -->
		<result property="ordUnit"			column="ORD_UNIT"			/>	<!-- 발주단위 -->
		<result property="ordIpsu"			column="ORD_IPSU"			/>	<!-- 발주입수 -->
		<result property="buyDan"			column="BUY_DAN"			/>	<!-- 상품매입단가 -->
		<result property="strNm"			column="STR_NM"				/>	<!-- 점포명 -->
		<result property="ordQty"			column="ORD_QTY"			/>	<!-- 발주수량 -->
		<result property="buyPrc"			column="BUY_PRC"			/>	<!-- 원가 -->
		<result property="negoBuyPrc"		column="NEGO_BUY_PRC"		/>	<!-- 협상원가 -->
		<result property="homeNm"			column="HOME_NM"			/>	<!-- 원산지명 -->
		<result property="ordSlipNo"		column="ORD_SLIP_NO"		/>	<!-- 발주전표번호 -->
		<result property="splyAbleQty"		column="SPLY_ABLE_QTY"		/>	<!-- 납품가능수량 -->
		<result property="strCd"			column="STR_CD"				/>	<!-- 점포코드 -->
		<result property="producer"			column="PRODUCER"			/>	<!-- 원산지명 -->
		<result property="venCd"			column="VEN_CD"				/>	<!-- 업체코드 -->
	</resultMap>

	<select id="TSC_ORD_SPLY-SELECT01" resultMap="NEDMORD0120VOMap" parameterClass="NEDMORD0120VO">
		/* NEDMORD0120.TSC_ORD_SPLY-SELECT01 */
		SELECT  A.PROD_CD
			,	A.SRCMK_CD
			,	A.PROD_NM
			,	A.PROD_STD
			,	C1.MINOR_CD 		AS ORD_UNIT
			,	A.ORD_IPSU
			,	SUM(A.BUY_DAN) 		AS BUY_DAN
			,	B.STR_NM 			AS STR_NM
			,	SUM(A.ORD_QTY) 		AS ORD_QTY
			,	SUM(A.BUY_PRC) 		AS BUY_PRC
			,	A.NEGO_BUY_PRC
			,	A.HOME_NM
			,	A.ORD_SLIP_NO
			,	SUM(A.SPLY_ABLE_QTY) AS SPLY_ABLE_QTY
			,	A.STR_CD
			,	A.PRODUCER
			,	A.VEN_CD
		FROM 	TPC_ORD_PROD A
				LEFT OUTER JOIN TPC_CODE C1 ON A.ORD_UNIT = C1.MINOR_CD
				INNER JOIN STORE B ON A.STR_CD = B.STR_CD
		WHERE 	A.ORD_DY BETWEEN replace(#srchStartDate#,'-','') and replace(#srchEndDate#,'-','')
			AND A.STR_CD NOT IN ('D03', 'W03')
			AND A.PDC_ORD_SLIP_NO IS NULL
			
			<isNotEmpty  property="venCds" prepend="AND">
				<iterate prepend="A.VEN_CD IN " property="venCds" open="(" close=")" conjunction=",">
					#venCds[]#
				</iterate>
			</isNotEmpty>
			
			<isNotEmpty prepend="AND" property="searchEntpCd">
				A.VEN_CD = #searchEntpCd#
			</isNotEmpty>
			
			<isNotEmpty prepend="AND" property="searchStoreAl">
				<iterate prepend="B.STR_CD IN " property="searchStoreAl" open="(" close=")" conjunction=",">
					#searchStoreAl[]#
				</iterate>
			</isNotEmpty>
			
			<isNotEmpty prepend="AND" property="searchProductVal">
				A.PROD_CD = #searchProductVal#
			</isNotEmpty>
		
		
		GROUP BY  	A.SRCMK_CD
				,	A.PROD_CD
				,	A.PROD_NM
				,	A.PROD_STD
				,	C1.MINOR_CD
				,	A.ORD_IPSU
				,	A.STR_CD
				,	A.NEGO_BUY_PRC
				,	A.HOME_NM
				,	A.PRODUCER
				,	A.ORD_SLIP_NO
				,	B.STR_NM
				,	A.VEN_CD
		ORDER BY A.PROD_CD, A.STR_CD	     
	</select>

	<!-- 신선매입정보수정 -->
	<update id="TSC_ORD_SPLY-UPDATE01" parameterClass="NEDMORD0120VO">
		/* NEDMORD0120.TSC_ORD_SPLY-UPDATE01 */
		UPDATE 	TPC_ORD_PROD
		SET		NEGO_BUY_PRC 	= #negoBuyPrc#
			,	HOME_NM 		= #producer#
			,	PRODUCER 		= #producer#
			,	LST_CHG_DT 		= CURRENT_TIMESTAMP(0)
		WHERE 	ORD_SLIP_NO 	= #ordSlipNo#
			AND VEN_CD 			= #venCd#
			AND PROD_CD 		= #prodCd#
	</update>
	
</sqlMap>
