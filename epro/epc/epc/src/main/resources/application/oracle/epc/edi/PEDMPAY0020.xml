<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="PEDMPAY0020">

<typeAlias alias="resultClass"	type="lcn.module.common.util.HashBox" />
<typeAlias alias="paramClass"	type="lcn.module.common.util.HashBox" />

<!-- 거래실적조회 -->
<select id="TSC_CRED_LED-SELECT01" parameterClass="map" resultClass="resultClass">
	SELECT  BUY_YM
	       ,NVL(SUM(TRANS_BUY_AMT), 0) AS TRANS_BUY_AMT_TOTAL
	       ,NVL(SUM(TRANS_VAT), 0) AS TRANS_VAT_TOTAL
	       ,NVL(SUM(BUY_AMT), 0) AS BUY_AMT_TOTAL
	       ,NVL(SUM(VAT), 0) AS VAT_TOTAL
	       ,NVL(SUM(PAY_BUY_AMT), 0) AS PAY_BUY_AMT_TOTAL
	       ,NVL(SUM(PAY_VAT), 0) AS PAY_VAT_TOTAL
	       ,NVL(SUM(REM_BUY_AMT), 0) AS REM_BUY_AMT_TOTAL
	       ,NVL(SUM(REM_VAT), 0) AS REM_VAT_TOTAL
	       ,NVL(SUM(REM_BUY_AMT), 0) + NVL(SUM(REM_VAT), 0) AS REM_SUM_TOTAL
	
	FROM TED_CRED_BUY_LED
	
	WHERE BUY_YM BETWEEN replace(#startDate#,'-','') and replace(#endDate#,'-','')
	  
	    <isNotEmpty  property="venCds"  prepend="AND"> 
	      <iterate prepend="VEN_CD IN " property="venCds" open="(" close=")" conjunction=","> 
	        #venCds[]# 
	      </iterate> 
	    </isNotEmpty>
	    
	    <isNotEmpty prepend="AND" property="entp_cd"> 
	    	VEN_CD = #entp_cd#
	    </isNotEmpty>
	
	GROUP BY BUY_YM
	ORDER BY BUY_YM
		 
</select>

<!-- 점포별 거래실적 -->
<select id="TSC_CRED_LED_STORE_DETAIL-SELECT01" parameterClass="map" resultClass="resultClass">
	SELECT  A.BUY_YM
	       ,A.STR_CD
	       ,NVL(C.STR_NM,'no code') AS STR_NM
	       ,A.BMAN_NO
	       ,NVL(A.TRANS_BUY_AMT, 0) AS TRANS_BUY_AMT
	       ,NVL(A.TRANS_VAT, 0) AS TRANS_VAT
	       ,NVL(A.BUY_AMT, 0) AS BUY_AMT
	       ,NVL(A.VAT, 0) AS VAT
	       ,NVL(A.PAY_BUY_AMT, 0) AS PAY_BUY_AMT
	       ,NVL(A.PAY_VAT, 0) AS PAY_VAT
	       ,NVL(A.REM_BUY_AMT, 0) AS REM_BUY_AMT
	       ,NVL(A.REM_VAT, 0) AS REM_VAT
	       ,NVL((A.REM_BUY_AMT + A.REM_VAT), 0) AS REM_SUM
	       ,'' AS BORU
	
	FROM
	
	(SELECT  BUY_YM
	       ,STR_CD
	       ,BMAN_NO
	       ,SUM(TRANS_BUY_AMT) AS TRANS_BUY_AMT
	       ,SUM(TRANS_VAT) AS TRANS_VAT
	       ,SUM(BUY_AMT) AS BUY_AMT
	       ,SUM(VAT) AS VAT
	       ,SUM(PAY_BUY_AMT) AS PAY_BUY_AMT
	       ,SUM(PAY_VAT) AS PAY_VAT
	       ,SUM(REM_BUY_AMT) AS REM_BUY_AMT
	       ,SUM(REM_VAT) AS REM_VAT
	       ,(SUM(REM_BUY_AMT) + SUM(REM_VAT)) AS REM_SUM
	
	FROM TED_CRED_BUY_LED
	
	WHERE BUY_YM BETWEEN replace(#startDate#,'-','') and replace(#endDate#,'-','')
	    <isNotEmpty  property="venCds"  prepend="AND"> 
	      <iterate prepend="VEN_CD IN " property="venCds" open="(" close=")" conjunction=","> 
	        #venCds[]# 
	      </iterate> 
	    </isNotEmpty>
	    
	    <isNotEmpty prepend="AND" property="entp_cd"> 
	    	VEN_CD = #entp_cd#
	    </isNotEmpty>
	
	GROUP BY BUY_YM, BMAN_NO, STR_CD
	) A LEFT OUTER JOIN
		
	(SELECT  AA.CRED_BUY_APPLY_MM
	       ,AA.STR_CD
	       ,REPLACE((MAX(AA.ACCT_NM_A) || MAX(AA.ACCT_NM_B) || MAX(AA.ACCT_NM_C) || MAX(AA.ACCT_NM_D) || MAX(AA.ACCT_NM_E) || 
	                 MAX(AA.ACCT_NM_F) || MAX(AA.ACCT_NM_G) || MAX(AA.ACCT_NM_H) || MAX(AA.ACCT_NM_I) || MAX(AA.ACCT_NM_J)) ,' ',''  ) AS BORU
	
	FROM 
	
	(SELECT  A.CRED_BUY_APPLY_MM AS CRED_BUY_APPLY_MM
	       ,A.VEN_CD AS VEN_CD
	       ,A.STR_CD AS STR_CD
	       ,DECODE(B.ACCT_CD,'63',MAX(B.ACCT_NM || ' '), ' ' ) AS ACCT_NM_A
	       ,DECODE(B.ACCT_CD,'64',MAX(B.ACCT_NM || ' '), ' ' ) AS ACCT_NM_B
	       ,DECODE(B.ACCT_CD,'65',MAX(B.ACCT_NM || ' '), ' ' ) AS ACCT_NM_C
	       ,DECODE(B.ACCT_CD,'66',MAX(B.ACCT_NM || ' '), ' ' ) AS ACCT_NM_D
	       ,DECODE(B.ACCT_CD,'67',MAX(B.ACCT_NM || ' '), ' ' ) AS ACCT_NM_E
	       ,DECODE(B.ACCT_CD,'68',MAX(B.ACCT_NM || ' '), ' ' ) AS ACCT_NM_F
	       ,DECODE(B.ACCT_CD,'69',MAX(B.ACCT_NM || ' '), ' ' ) AS ACCT_NM_G
	       ,DECODE(B.ACCT_CD,'70',MAX(B.ACCT_NM || ' '), ' ' ) AS ACCT_NM_H
	       ,DECODE(B.ACCT_CD,'71',MAX(B.ACCT_NM || ' '), ' ' ) AS ACCT_NM_I
	       ,DECODE(B.ACCT_CD,'72',MAX(B.ACCT_NM || ' '), ' ' ) AS ACCT_NM_J
	
	
	FROM TED_SUB_AGG A INNER JOIN TED_ACCOUNT B ON A.ACCT_CD = B.ACCT_CD
	                                   AND B.ACCT_CD IN ('63','64','65','66','67','68','69','71','72','73')
	
	WHERE A.SUB_MM BETWEEN replace(#startDate#,'-','') and replace(#endDate#,'-','')
	    <isNotEmpty  property="venCds"  prepend="AND"> 
	      <iterate prepend="VEN_CD IN " property="venCds" open="(" close=")" conjunction=","> 
	        #venCds[]# 
	      </iterate> 
	    </isNotEmpty>
	    
	    <isNotEmpty prepend="AND" property="entp_cd"> 
	    	VEN_CD = #entp_cd#
	    </isNotEmpty>
	
	GROUP BY A.CRED_BUY_APPLY_MM, A.VEN_CD, A.STR_CD, B.ACCT_CD
	) AA
	
	GROUP BY AA.CRED_BUY_APPLY_MM, AA.STR_CD
	) B ON A.STR_CD = B.STR_CD
	   AND A.BUY_YM = B.CRED_BUY_APPLY_MM
	INNER JOIN STORE C ON C.STR_CD = A.STR_CD
	
	ORDER BY A.BUY_YM, A.STR_CD
		 
</select>

<!-- 잔액조회 -->
<select id="TSC_CRED_LED_STORE-SELECT01" parameterClass="map" resultClass="resultClass">
	SELECT  A.BUY_YM
	       ,B.STR_CD
	       ,B.STR_NM
	       ,A.BMAN_NO
	       ,NVL(SUM(REM_BUY_AMT), 0) AS REM_BUY_AMT
	       ,NVL(SUM(REM_VAT), 0) AS REM_VAT
	       ,NVL(SUM(REM_BUY_AMT), 0) + NVL(SUM(REM_VAT), 0) AS REM_SUM
	
	FROM TED_CRED_BUY_LED A INNER JOIN STORE@dl_md_martnis B ON A.STR_CD = B.STR_CD
	
	WHERE BUY_YM BETWEEN replace(#startDate#,'-','') and replace(#endDate#,'-','')

    	<isNotEmpty  property="venCds"  prepend="AND"> 
	      <iterate prepend="VEN_CD IN " property="venCds" open="(" close=")" conjunction=","> 
	        #venCds[]# 
	      </iterate> 
	    </isNotEmpty>
	    
	    <isNotEmpty prepend="AND" property="entp_cd"> 
	    	VEN_CD = #entp_cd#
	    </isNotEmpty>
	
	GROUP BY A.BUY_YM, B.STR_CD, B.STR_NM, A.BMAN_NO
	ORDER BY A.BUY_YM, A.BMAN_NO, B.STR_CD

</select>

<!-- 패밀리론 -->
<select id="TSC_FAMILY_LOAN-SELECT01" parameterClass="map" resultClass="resultClass">
	SELECT  A.NETLOAN_SLIP_NO AS SLIP_NO,     

  		    GET_PAYDAY_FNC@dl_md_martnis(A.SPLY_CYCLE,A.SPLY_SEQ,SUBSTR(A.BUY_DY,1,6)) AS PAY_DY,    

			A.TOT_BANK_SEND_AMT AS SEND_AMT,
			A.TOT_BANK_ABLE_AMT AS ABLE_AMT,  
			A.SPLY_AMT AS SPLY_AMT,       
			A.LOGI_AMT AS LOGI_AMT,       
			A.SALE_PROMO_AMT AS SALE_PROMO_AMT,     
			A.RTN_AMT AS RTN_AMT,        
			A.PAY_AMT AS PAY_AMT,       
			decode(send_fg,02,a.pay_amt,0) AS AAA,    
			decode(send_fg,02,ROUND(A.PAY_AMT*0.8,0),0) AS BBB,   
			A.TOT_BANK_SEND_AMT + decode(send_fg,02,a.pay_amt,0) AS CCC,   
			A.TOT_BANK_ABLE_AMT + decode(send_fg,02,ROUND(A.PAY_AMT*0.8,0),0) AS DDD 

	FROM    PLS_NETLOAN_HIST_NEW@dl_md_martnis A    
	
	WHERE 	A.BUY_DY BETWEEN replace(#startDate#,'-','') and replace(#endDate#,'-','')
	
			<isNotEmpty  property="venCds"  prepend="AND"> 
		      <iterate prepend="A.VEN_CD IN " property="venCds" open="(" close=")" conjunction=","> 
		        #venCds[]# 
		      </iterate> 
		    </isNotEmpty>
		    
		    <isNotEmpty  property="entp_cd"  prepend="AND"> 
		    	A.VEN_CD = #entp_cd#
	 	    </isNotEmpty>

   ORDER BY A.NETLOAN_SLIP_NO asc

</select>

</sqlMap>
