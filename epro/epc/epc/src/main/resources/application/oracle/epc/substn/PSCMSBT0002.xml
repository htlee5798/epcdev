<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="pscmsbt0002">

    <typeAlias alias="dataMap" type="com.lottemart.common.util.DataMap" />

    <!-- 업체별 매출공제 목록 -->
    <select id="selectVendorSubStnList" resultClass="dataMap">
	SELECT Z.TAXAT_DIVN  /* 과세 면세 구분 */
		  ,Z.SALE_VENDOR_ID  /* 상위업체코드 */
		  ,Z.SALE_VENDOR_NM
		  ,Z.VENDOR_ID /* 하위업체코드 */
		  ,Z.VENDOR_NM
		  ,Z.BUY_PRC AS BUY_PRC  /* 원가가액 */
		  ,CASE WHEN TAXAT_DIVN = '과세' 
				THEN Z.TOTAL_ORDER_AMT - ( Z.CUPON_VEN_AMT + CARD_VEN_AMT + Z.CUPON_COM_AMT + CARD_COM_AMT + Z.CARDCO_CARD_COM_AMT + Z.MILEAGE_DIV_AMT + Z.BANN_DIV_AMT ) -  Z.TAX_AMT
				ELSE Z.TOTAL_ORDER_AMT - ( Z.CUPON_VEN_AMT + CARD_VEN_AMT + Z.CUPON_COM_AMT + CARD_COM_AMT + Z.CARDCO_CARD_COM_AMT + Z.MILEAGE_DIV_AMT + Z.BANN_DIV_AMT )
		   END AS VOS
		  ,CASE WHEN Z.CANCEL_CNT = 0 THEN Z.ORDER_AMT 
				WHEN Z.CANCEL_CNT &gt; 0 THEN Z.ORDER_AMT - (( Z.CUPON_VEN_AMT + CARD_VEN_AMT + Z.CUPON_COM_AMT + CARD_COM_AMT
					 + Z.CARDCO_CARD_COM_AMT + Z.MILEAGE_DIV_AMT + Z.BANN_DIV_AMT ))
		   END  AS ORDER_AMT  /* 매출금액 */
		  ,Z.SALE_QTY AS SALE_QTY
		  ,Z.SALE_AMT AS SALE_AMT
		  ,Z.DC_AMT AS DC_AMT
		  ,Z.PART_CANCEL_CNT AS PART_CANCEL_CNT  /*부분취소반품건수*/ 
		  ,Z.DELIVERY_DIV_AMT AS SALE_DELIVERY_AMT  --매출배송료
		  ,Z.CUPON_VEN_AMT + CARD_VEN_AMT AS VEN_AMT
		  ,Z.CUPON_COM_AMT + CARD_COM_AMT AS COM_AMT
		  ,Z.CUPON_VEN_AMT AS CUPON_VEN_AMT
		  ,Z.CUPON_COM_AMT AS CUPON_COM_AMT
		  ,Z.CARD_VEN_AMT  AS CARD_VEN_AMT
		  ,Z.CARD_COM_AMT  AS CARD_COM_AMT
		  ,Z.DELIVERY_DIV_AMT AS DELIVERY_DIV_AMT
		  ,Z.ORDER_CNT AS ORDER_CNT     /* 매출수량 */
		  ,Z.CANCEL_CNT  AS CANCEL_CNT  /* 매출반품수량 */
		  ,CASE WHEN TAXAT_DIVN = '과세' THEN Z.TAX_AMT ELSE 0
		   END  TAX_AMT
		  ,Z.PROFIT_AMT AS PROFIT_AMT  /* 수수료금액 */
		  ,Z.TOTAL_ORDER_AMT  /* 총매출 */
		  ,Z.TOTAL_ORDER_AMT - ( Z.CUPON_VEN_AMT + CARD_VEN_AMT + Z.CUPON_COM_AMT + CARD_COM_AMT + Z.CARDCO_CARD_COM_AMT + Z.MILEAGE_DIV_AMT + Z.BANN_DIV_AMT ) AS S_ACCOUNT
	FROM (
			SELECT CASE WHEN x.TAXAT_DIVN_CD = '0' THEN '면세'
						WHEN x.TAXAT_DIVN_CD IN ('1' , '3') then '과세'
						WHEN x.TAXAT_DIVN_CD = '2' then '영세'
					END AS TAXAT_DIVN /* 과세 면세 구분 */
				  ,X.SALE_VENDOR_ID  /* 상위업체코드 */
				  ,X.SALE_VENDOR_NM
				  ,X.VENDOR_ID  /* 하위업체코드 */
				  ,X.VENDOR_NM
				  ,x.TAXAT_DIVN_CD
				  ,SUM(BUY_PRC)    AS BUY_PRC  /* 원가액 */
				  ,SUM(TAX_AMT)    AS TAX_AMT  /* 부가세 */
				  ,SUM(PROFIT_AMT) AS PROFIT_AMT  /* 수수료금액 */
				  ,SUM(ORDER_AMT)  AS ORDER_AMT  /* 매출금액 */
				  ,SUM(SALE_QTY)   AS ORDER_CNT  /* 매출수량 */
				  ,SUM(CANCEL_ORDER_AMT)  AS CANCEL_ORDER_AMT /* 매출반품 */
				  ,SUM(CANCEL_SALE_QTY)  AS CANCEL_CNT  /* 매출반품수량 */
				  ,SUM(TOTAL_ORDER_AMT)  AS TOTAL_ORDER_AMT  /* 총매출 */
				  ,SUM(SALE_QTY)AS SALE_QTY
				  ,SUM(SALE_AMT)AS SALE_AMT
				  ,SUM(DC_AMT)AS DC_AMT
				  ,SUM(PART_CANCEL_CNT)  AS PART_CANCEL_CNT  /*부분취소반품건수*/ 
				  ,SUM(SALE_DELIVERY_AMT) AS SALE_DELIVERY_AMT  --매출배송료
				  ,SUM(CUPON_VEN_AMT) AS CUPON_VEN_AMT
				  ,SUM(CUPON_COM_AMT) AS CUPON_COM_AMT
				  ,SUM(CARD_VEN_AMT) AS CARD_VEN_AMT
				  ,SUM(CARD_COM_AMT) AS CARD_COM_AMT
				  ,SUM(CARDCO_CARD_COM_AMT) AS CARDCO_CARD_COM_AMT
				  ,SUM(MILEAGE_DIV_AMT) AS MILEAGE_DIV_AMT
				  ,SUM(BANN_DIV_AMT) AS BANN_DIV_AMT
				  ,SUM(DELIVERY_DIV_AMT) AS  DELIVERY_DIV_AMT
				FROM (
	   SELECT  TT.WORKSTATIONID AS POS_NO   --POS NO
			  ,FN_GET_TR_TYPE( tt.WORKSTATIONID ) AS SALE_FG
			  ,TT.BUSINESSDAYDATE AS SALE_DT  --일자
			  ,TT.TRANSNUMBER,TT.TRANSTYPECODE
			  ,CASE WHEN VD.SALE_VENDOR_ID = '999002' THEN (SELECT SALE_VENDOR_ID FROM TVE_VENDOR WHERE VENDOR_ID = OI.STR_VENDOR_ID) ELSE VD.SALE_VENDOR_ID END AS SALE_VENDOR_ID
			  ,CASE WHEN VD.VENDOR_ID = '999002' THEN (SELECT VENDOR_NM FROM TVE_VENDOR WHERE VENDOR_ID = OI.STR_VENDOR_ID) ELSE VD.VENDOR_NM END AS SALE_VENDOR_NM
			  ,CASE WHEN VD.VENDOR_ID = '999002' THEN (SELECT VENDOR_ID FROM TVE_VENDOR WHERE VENDOR_ID = OI.STR_VENDOR_ID) ELSE VD.VENDOR_ID END AS VENDOR_ID
			  ,CASE WHEN VD.VENDOR_ID = '999002' THEN (SELECT VENDOR_NM FROM TVE_VENDOR WHERE VENDOR_ID = OI.STR_VENDOR_ID) ELSE VD.VENDOR_NM END AS VENDOR_NM
			  ,OI.ORD_ITEM_DIVN_CD
			  ,OI.ORDER_ITEM_SEQ
			  ,OI.ORDER_ID  --주문번호
			  ,OI.PROD_CD AS PROD_CD  --상품코드
			  ,PD.PROD_NM
			  ,(SELECT TPR.PROFIT_RATE FROM TPR_PRODUCT  TPR WHERE TPR.MD_PROD_CD = OI.REP_PROD_CD) PRFT_RATE
			  , CASE WHEN TTX.TAXTYPECODE = '3' THEN '1' ELSE TTX.TAXTYPECODE END AS TAXAT_DIVN_CD  /* 0:면세,1:과세,2:영세 */
			  ,OI.ORD_QTY 
			  ,OI.BUY_PRC AS ORI_BUY_PRC
			  ,CASE WHEN TTX.TAXTYPECODE IN ( '1' , '3') /*과세*/
					  THEN CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN (OI.BUY_PRC * OI.ORD_QTY )  ELSE 0 END /*과세*/
					WHEN TTX.TAXTYPECODE IN ( '0','2') /*면세, 영세*/
					  THEN CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN OI.BUY_PRC  ELSE 0 END /*면세,영세*/
			   END AS BUY_PRC
			  ,OI.CURR_SELL_PRC
			  ,CASE WHEN TTX.TAXTYPECODE = '1' /*과세*/
					  THEN CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') 
								  THEN CASE WHEN FN_GET_TR_TYPE( tt.WORKSTATIONID ) = '3' 
											  THEN DECODE(TTX.TAXTYPECODE ,'1', 
																				ROUND(
																				( (OI.ORD_QTY * OI.CURR_SELL_PRC) 
																				   - 
																				  ( EN.CUPON_VEN_AMT + EN.CUPON_COM_AMT + EN.CARD_VEN_AMT + EN.CARD_COM_AMT + EN.CARDCO_CARD_COM_AMT + EN.MILEAGE_DIV_AMT + EN.BANN_DIV_AMT )
																				 )
																				- 
																				( ((OI.ORD_QTY * OI.CURR_SELL_PRC) 
																				   - 
																				  ( EN.CUPON_VEN_AMT + EN.CUPON_COM_AMT + EN.CARD_VEN_AMT + EN.CARD_COM_AMT + EN.CARDCO_CARD_COM_AMT + EN.MILEAGE_DIV_AMT + EN.BANN_DIV_AMT ))
																				   / 1.1
																				 ),0)
														  )
											WHEN FN_GET_TR_TYPE( tt.WORKSTATIONID ) = '4'
											  THEN DECODE(TTX.TAXTYPECODE ,'1',
																				ROUND(
																				-(( (OI.ORD_QTY * OI.CURR_SELL_PRC) 
																				   + 
																				  ( EN.CUPON_VEN_AMT + EN.CUPON_COM_AMT + EN.CARD_VEN_AMT + EN.CARD_COM_AMT + EN.CARDCO_CARD_COM_AMT + EN.MILEAGE_DIV_AMT + EN.BANN_DIV_AMT )
																				 )
																				- 
																				( ((OI.ORD_QTY * OI.CURR_SELL_PRC) 
																				   + 
																				  ( EN.CUPON_VEN_AMT + EN.CUPON_COM_AMT + EN.CARD_VEN_AMT + EN.CARD_COM_AMT + EN.CARDCO_CARD_COM_AMT + EN.MILEAGE_DIV_AMT + EN.BANN_DIV_AMT ))
																				   / 1.1
																				 )),0)
														  )
											ELSE 0 
									   END
								   ELSE 0 
							END /*과세*/
					WHEN TTX.TAXTYPECODE = '0' /*면세, 영세*/  
					  THEN CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') 
								  THEN DECODE(TTX.TAXTYPECODE ,'1', ROUND((OI.ORD_QTY * OI.CURR_SELL_PRC) - ((OI.ORD_QTY * OI.CURR_SELL_PRC) / 1.1),0) , 0) ELSE 0 END /*면세, 영세*/
			   END AS TAX_AMT
			  , TT.REP_PROD_CD
			  ,(SELECT CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN
					   (CASE WHEN FN_GET_TR_TYPE( TT.WORKSTATIONID ) = '3' THEN (OI.ORD_QTY * OI.CURR_SELL_PRC) * (TPR.PROFIT_RT/100) ELSE ((OI.ORD_QTY * OI.CURR_SELL_PRC) * (TPR.PROFIT_RT/100)) * -1   END) ELSE 0 END
				  FROM PRODUCT  TPR 
				 WHERE TPR.PROD_CD = TT.REP_PROD_CD
			   ) AS PROFIT_AMT
			  ,NVL((SELECT DECODE(PART_CANCEL_YN,'Y','1','0') 
							FROM TOR_ORDER  O,
							   TDE_DELI_MST  DM
							WHERE O.FIRST_ORDER_ID = DM.ORDER_ID
							   AND O.ORDER_ID = OI.ORDER_ID
							   AND DM.DELI_DIVN_CD ='10' --주문정상
							   AND DM.INVOICE_STATUS_CD = '10' --송장정상
							   AND DM.DELI_TYPE_CD IN ('01','02','03','08') -- 근거리/자사택배/픽업/해외배송만
							   AND DM.DELI_DIVN_DTL_CD ='11' -- 배송지시만
							   AND OI.POS_NO IN (SELECT POS_NO FROM TET_TLOG_POS WHERE SALE_TYPE  = '4')
							   LIMIT 1 ),'0') AS PART_CANCEL_CNT
			  ,CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN
						 (CASE WHEN FN_GET_TR_TYPE( tt.WORKSTATIONID ) = '3'
						 THEN (OI.ORD_AMT ) 
						 ELSE (OI.ORD_AMT) * -1  END) ELSE 0 END AS ORDER_AMT
			  ,CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN
						 (CASE WHEN FN_GET_TR_TYPE( tt.WORKSTATIONID ) = '4' THEN (OI.ORD_QTY) * OI.CURR_SELL_PRC ELSE 0 END) ELSE 0 END AS CANCEL_ORDER_AMT
						 
			  ,CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN
						(CASE WHEN FN_GET_TR_TYPE( tt.WORKSTATIONID ) = '3' THEN (OI.ORD_AMT) ELSE ((OI.ORD_AMT)) * -1  END) ELSE 0 END AS TOTAL_ORDER_AMT
			  ,CASE WHEN FN_GET_TR_TYPE( tt.WORKSTATIONID ) = '3' THEN  OI.ORD_QTY  ELSE (OI.ORD_QTY - OI.ACCEPT_QTY) * -1 END AS SALE_QTY
			  ,CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN        
						 (CASE WHEN FN_GET_TR_TYPE( tt.WORKSTATIONID ) = '4' THEN OI.ORD_QTY  ELSE 0 END) ELSE 0 END AS CANCEL_SALE_QTY
			  ,CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN  OI.EXTRA_QTY ELSE 0 END AS EXTRA_QTY
			  ,CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN OI.CURR_SELL_PRC ELSE 0 END AS SALE_AMT
			  ,CASE WHEN FN_GET_TR_TYPE( tt.WORKSTATIONID ) = '3' THEN (SELECT TOT_SELL_AMT FROM TOR_ORDER_ITEM  A
														 WHERE A.ORDER_ID = TT.ORDER_ID AND A.STR_VENDOR_ID = OI.STR_VENDOR_ID
														   AND A.ORD_ITEM_DIVN_CD IN ('11','12','13')
														   AND A.ORDER_ITEM_SEQ = OI.ORDER_ITEM_SEQ)
					ELSE (SELECT TOT_SELL_AMT FROM TOR_ORDER_ITEM  A
														 WHERE A.ORDER_ID = TT.ORDER_ID AND A.STR_VENDOR_ID = OI.STR_VENDOR_ID
														   AND A.ORD_ITEM_DIVN_CD IN ('11','12','13')
														   AND A.ORDER_ITEM_SEQ = OI.ORDER_ITEM_SEQ) * -1 END AS SALE_DELIVERY_AMT
			  ,EN.CUPON_COM_AMT+EN.CARD_COM_AMT AS DC_AMT
			  ,EN.CUPON_VEN_AMT as CUPON_VEN_AMT
			  ,EN.CUPON_COM_AMT as CUPON_COM_AMT
			  ,EN.CARD_VEN_AMT as CARD_VEN_AMT
			  ,EN.CARD_COM_AMT as CARD_COM_AMT
			  ,EN.CARDCO_CARD_COM_AMT as CARDCO_CARD_COM_AMT
			  ,EN.MILEAGE_DIV_AMT as MILEAGE_DIV_AMT
			  ,EN.BANN_DIV_AMT as BANN_DIV_AMT
			  ,EN.DELIVERY_DIV_AMT -- 매출 배송비
			  ,EN.ORDER_SEQ
		  FROM TOR_ORDER_ITEM  OI
		INNER JOIN TSA_TLOGSELECT  TT
				ON TT.RETAILSTOREID IN ('981', '309', PG_UTIL.FN_GET_FEDAY_MALL_STR_CD())
			   AND TT.BUSINESSDAYDATE BETWEEN #frDt# AND #toDt#
			   AND TT.RECORDQUALIFIER = '5'
			   AND SUBSTR(TT.WORKSTATIONID, 1, 2) IN ('83', '85', '84', '86')
			   AND TT.TRANSTYPECODE NOT IN ('0050', '0060')
			   /* 속도 문제로 쿼리 튜닝 */
			   AND TT.IF_LOAD_YN = 'Y'  /* IF 적재여부 TSA_TLOGSELECT_3 */
			   AND OI.ORDER_ID = TT.ORDER_ID 
			   AND OI.ORDER_ITEM_SEQ = TT.ORDER_ITEM_SEQ
		INNER JOIN TSA_TLOGSELECT  TTX  /* TPR_PRODUCT 의 과면세 구분을 사용하면 안되서 추가함 */
				ON TTX.RETAILSTOREID IN ('981', '309', PG_UTIL.FN_GET_FEDAY_MALL_STR_CD())
			   AND TTX.BUSINESSDAYDATE BETWEEN #frDt# AND #toDt#
			   AND TTX.RECORDQUALIFIER = '13'
			   AND SUBSTR(TTX.WORKSTATIONID, 1, 2) IN ('83', '85', '84', '86')
			   AND TTX.TRANSTYPECODE NOT IN ('0050', '0060')
			   /* 속도 문제로 쿼리 튜닝 */
			   AND TTX.IF_LOAD_YN = 'Y'  /* IF 적재여부 TSA_TLOGSELECT_3 */
			   AND OI.ORDER_ID = TTX.ORDER_ID 
			   AND OI.ORDER_ITEM_SEQ = TTX.ORDER_ITEM_SEQ
		INNER JOIN TPR_PRODUCT  PD
				ON OI.PROD_CD = PD.PROD_CD
		INNER JOIN TVE_VENDOR  VD
				ON PD.VENDOR_ID = VD.VENDOR_ID
		INNER JOIN V_CA_MD_CATEGORY  VC
				ON PD.CAT_CD     = VC.L3_CD
		INNER JOIN  /*에누리 금액*/
					(SELECT SS_S.ORDER_ID --수정부분 by hyena
							,SS_S.ORDER_ITEM_SEQ --수정부분 by hyena
							,SUM(SS_S.CUPON_DIV_AMT) as CUPON_VEN_AMT   /* 쿠폰 타사 분담금*/ 
							,SUM(SS_S.CPN_COM_SHCH) as CUPON_COM_AMT /* 쿠폰 자사 분담금*/
							,SUM(SS_S.CARD_CARDCO_SHCH) AS CARD_VEN_AMT /* 카드 타사 분담금*/ 
							,SUM(SS_S.CARD_COM_SHCH) AS CARD_COM_AMT /* 카드 자사 분담금  */
							, 0 AS CARDCO_CARD_COM_AMT --카드사 분담금
							,SUM(SS_S.MILEAGE_DIV_AMT)  AS MILEAGE_DIV_AMT /* 마일리지*/
							, 0 AS BANN_DIV_AMT -- 배너광고비
							,SUM(SS_S.DELIVERY_AMT) + SUM(NVL(SS_S.DELIVERY_COUPON_AMT,0)) AS DELIVERY_DIV_AMT /* 매출 배송비 */
							, '1'  AS ORDER_SEQ
						  FROM TRST_SUBSTN_PROD_LOG  SS_S
							 , TVE_VENDOR  VD_S
							 , tpr_product  PD_S
						  where SS_S.PROD_CD  = PD_S.PROD_CD
							AND SS_S.SALE_DY BETWEEN #frDt# AND #toDt#
							<isNotEmpty property="vendorId">
							AND VD_S.SALE_VENDOR_ID = #vendorId#   /* 협력업체코드*/
							</isNotEmpty>
							AND  SS_S.VENDOR_ID = VD_S.VENDOR_ID 
							AND  PD_S.TAXAT_DIVN_CD IN ('0', '1', '2') /*0:면세,1:과세,2:영세*/
						 GROUP BY SS_S.ORDER_ID, SS_S.ORDER_ITEM_SEQ 
				   ) EN
				ON OI.ORDER_ID = EN.ORDER_ID
			   AND OI.ORDER_ITEM_SEQ = EN.ORDER_ITEM_SEQ
		  WHERE (    OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13')
			     AND TTX.TAXTYPECODE IN ( '0','1','2')  /* 과세 기준 */
			     AND VD.VENDOR_KIND_CD = 'KM05'
			     <isNotEmpty property="catCd">
			     AND VC.L1_CD  = #catCd# /* 분류코드*/
			     </isNotEmpty>
			     <isNotEmpty property="vendorId">
			     AND VD.SALE_VENDOR_ID = #vendorId# /* 협력업체코드*/
			     </isNotEmpty>
                )
             OR (    OI.ORD_ITEM_DIVN_CD IN ('11','12','13')
                 AND TTX.TAXTYPECODE IN ( '0','1','2', '3')  /* 과세 기준 */
                 AND VD.VENDOR_KIND_CD = 'KM01'
                 <isNotEmpty property="catCd">
                 AND VC.L1_CD  = #catCd# /* 분류코드*/
                 </isNotEmpty> 
                 AND VD.SALE_VENDOR_ID = '999002' /* (주)롯데쇼핑 / 배송비상품*/
                 )
			) X
			GROUP BY X.SALE_VENDOR_ID, X.SALE_VENDOR_NM, X.VENDOR_ID, X.VENDOR_NM, X.TAXAT_DIVN_CD
		)Z
    </select>

    <!-- 업체별 매출상세 목록 -->
    <select id="selectProdSubStnList" resultClass="dataMap">
	SELECT ROW_NUMBER() OVER(ORDER BY 2 DESC) AS NUM
	      ,PROFIT_RT AS PROFIT_RATE /*수수료율  확인필요*/ 
		  ,ORDER_ID /*원주문번호*/
		  ,ORDER_ITEM_SEQ
	      ,POS_NO
		  ,SALE_FG
		  ,TRANSNUMBER
		  ,TRANSTYPECODE
		  ,SALE_VENDOR_ID /*업체코드*/
		  ,FIRST_ORDER_ID /*최종주문번호*/
		  ,SALE_DT AS ORDER_DT /*주문일자 확인필요 */
		  ,SALE_DT /*매출일자*/
		  ,PROD_CD /*상품코드*/
		  ,PROD_NM /*상품코드명*/
		  ,CASE WHEN TAXAT_DIVN_CD = '1' 
			  THEN TOTAL_ORDER_AMT - ( CUPON_VEN_AMT + CARD_VEN_AMT + CUPON_COM_AMT + CARD_COM_AMT + CARDCO_CARD_COM_AMT + MILEAGE_DIV_AMT + BANN_DIV_AMT ) - TAX_AMT
			  ELSE TOTAL_ORDER_AMT - ( CUPON_VEN_AMT + CARD_VEN_AMT + CUPON_COM_AMT + CARD_COM_AMT + CARDCO_CARD_COM_AMT + MILEAGE_DIV_AMT + BANN_DIV_AMT )
			END AS VOS  /*공급가액*/
		  ,TAX_AMT /*부가세*/
		  ,TOTAL_ORDER_AMT - ( CUPON_VEN_AMT + CARD_VEN_AMT + CUPON_COM_AMT + CARD_COM_AMT + CARDCO_CARD_COM_AMT + MILEAGE_DIV_AMT + BANN_DIV_AMT ) AS S_ACCOUNT /*S_ACCOUNT*/
		  ,DC_AMT /*에누리*/
		  ,TOTAL_ORDER_AMT /*총매출액*/
		  ,PROFIT_AMT /*수수료*/
		  ,SALE_DELIVERY_AMT /*배송료*/
		  ,SALE_QTY /*수량*/
		  ,SALE_VENDOR_NM
		  ,VENDOR_ID
		  ,VENDOR_NM
		  ,ORD_ITEM_DIVN_CD
		  ,PRFT_RATE
		  ,TAXAT_DIVN_CD
		  ,ORD_QTY
		  ,ORI_BUY_PRC
		  ,BUY_PRC
		  ,CURR_SELL_PRC
		  ,REP_PROD_CD
		  ,PART_CANCEL_CNT
		  ,ORDER_AMT
		  ,CANCEL_ORDER_AMT
		  ,CANCEL_SALE_QTY
		  ,EXTRA_QTY
		  ,SALE_AMT
		  ,CUPON_VEN_AMT
		  ,CUPON_COM_AMT
		  ,CARD_VEN_AMT
		  ,CARD_COM_AMT
		  ,CARDCO_CARD_COM_AMT
		  ,MILEAGE_DIV_AMT
		  ,BANN_DIV_AMT
		  ,DELIVERY_DIV_AMT
		  ,ORDER_SEQ
	  FROM (
	   SELECT  TT.WORKSTATIONID AS POS_NO   --POS NO
			  ,FN_GET_TR_TYPE( TT.WORKSTATIONID ) AS SALE_FG
			  ,TT.BUSINESSDAYDATE AS SALE_DT  --일자
			  ,TT.TRANSNUMBER,TT.TRANSTYPECODE
			  ,CASE WHEN VD.SALE_VENDOR_ID = '999002' THEN (SELECT SALE_VENDOR_ID FROM TVE_VENDOR WHERE VENDOR_ID = OI.STR_VENDOR_ID) ELSE VD.SALE_VENDOR_ID END AS SALE_VENDOR_ID
              ,CASE WHEN VD.VENDOR_ID = '999002' THEN (SELECT VENDOR_NM FROM TVE_VENDOR WHERE VENDOR_ID = OI.STR_VENDOR_ID) ELSE VD.VENDOR_NM END AS SALE_VENDOR_NM
              ,CASE WHEN VD.VENDOR_ID = '999002' THEN (SELECT VENDOR_ID FROM TVE_VENDOR WHERE VENDOR_ID = OI.STR_VENDOR_ID) ELSE VD.VENDOR_ID END AS VENDOR_ID
              ,CASE WHEN VD.VENDOR_ID = '999002' THEN (SELECT VENDOR_NM FROM TVE_VENDOR WHERE VENDOR_ID = OI.STR_VENDOR_ID) ELSE VD.VENDOR_NM END AS VENDOR_NM
			  ,OI.ORD_ITEM_DIVN_CD
			  ,OI.ORDER_ITEM_SEQ
			  ,OI.ORDER_ID  --주문번호
			  ,OI.FIRST_ORDER_ID
			  ,OI.PROD_CD AS PROD_CD  --상품코드 
			  ,PD.PROD_NM
			  ,(SELECT TPR.PROFIT_RATE FROM TPR_PRODUCT  TPR WHERE TPR.MD_PROD_CD = OI.REP_PROD_CD) PRFT_RATE
			  , CASE WHEN TTX.TAXTYPECODE = '3' THEN '1' ELSE TTX.TAXTYPECODE END AS TAXAT_DIVN_CD  /* 0:면세,1:과세,2:영세 */
			  ,OI.ORD_QTY
			  ,OI.BUY_PRC AS ORI_BUY_PRC
			  ,CASE WHEN TTX.TAXTYPECODE IN ( '1', '3' ) /*과세*/
					  THEN CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN (OI.BUY_PRC * OI.ORD_QTY )  ELSE 0 END /*과세*/
					WHEN TTX.TAXTYPECODE IN ( '0','2') /*면세, 영세*/  
					  THEN CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN OI.BUY_PRC  ELSE 0 END /*면세,영세*/
			   END AS BUY_PRC
			  ,OI.CURR_SELL_PRC
			  ,CASE WHEN TTX.TAXTYPECODE IN ( '1','3' ) /*과세*/
					  THEN CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') 
								  THEN CASE WHEN FN_GET_TR_TYPE( TT.WORKSTATIONID ) = '3' 
											  THEN DECODE(TTX.TAXTYPECODE ,'1', 
																				ROUND(
																				( (OI.ORD_QTY * OI.CURR_SELL_PRC) 
																				   - 
																				  ( EN.CUPON_VEN_AMT + EN.CUPON_COM_AMT + EN.CARD_VEN_AMT + EN.CARD_COM_AMT + EN.CARDCO_CARD_COM_AMT + EN.MILEAGE_DIV_AMT + EN.BANN_DIV_AMT )
																				 )
																				- 
																				( ((OI.ORD_QTY * OI.CURR_SELL_PRC) 
																				   - 
																				  ( EN.CUPON_VEN_AMT + EN.CUPON_COM_AMT + EN.CARD_VEN_AMT + EN.CARD_COM_AMT + EN.CARDCO_CARD_COM_AMT + EN.MILEAGE_DIV_AMT + EN.BANN_DIV_AMT ))
																				   / 1.1
																				 ),0)
														  )
											WHEN FN_GET_TR_TYPE( TT.WORKSTATIONID ) = '4'
											  THEN DECODE(TTX.TAXTYPECODE ,'1', 
																				ROUND(
																				-(( (OI.ORD_QTY * OI.CURR_SELL_PRC) 
																				   + 
																				  ( EN.CUPON_VEN_AMT + EN.CUPON_COM_AMT + EN.CARD_VEN_AMT + EN.CARD_COM_AMT + EN.CARDCO_CARD_COM_AMT + EN.MILEAGE_DIV_AMT + EN.BANN_DIV_AMT )
																				 )
																				- 
																				( ((OI.ORD_QTY * OI.CURR_SELL_PRC) 
																				   + 
																				  ( EN.CUPON_VEN_AMT + EN.CUPON_COM_AMT + EN.CARD_VEN_AMT + EN.CARD_COM_AMT + EN.CARDCO_CARD_COM_AMT + EN.MILEAGE_DIV_AMT + EN.BANN_DIV_AMT ))
																				   / 1.1
																				 )),0)
														  )
											ELSE 0 
									   END
								   ELSE 0 
							END /*과세*/
					WHEN TTX.TAXTYPECODE = '0' /*면세, 영세*/
					  THEN CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') 
								  THEN DECODE(TTX.TAXTYPECODE ,'1',ROUND((OI.ORD_QTY * OI.CURR_SELL_PRC) - ((OI.ORD_QTY * OI.CURR_SELL_PRC) / 1.1),0) , 0) ELSE 0 END /*면세, 영세*/                             
			   END AS TAX_AMT
			  , TT.REP_PROD_CD
			  ,(SELECT CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN
					    (CASE WHEN FN_GET_TR_TYPE( TT.WORKSTATIONID ) = '3' THEN (OI.ORD_QTY * OI.CURR_SELL_PRC) * (TPR.PROFIT_RT/100)  ELSE ((OI.ORD_QTY * OI.CURR_SELL_PRC) * (TPR.PROFIT_RT/100)) * -1  END) ELSE 0 END
				  FROM PRODUCT  TPR 
				 WHERE TPR.PROD_CD = TT.REP_PROD_CD
			   ) AS PROFIT_AMT
				,(SELECT TPR.PROFIT_RT
				  FROM PRODUCT  TPR 
				 WHERE TPR.PROD_CD = TT.REP_PROD_CD
			   ) AS PROFIT_RT
			  ,NVL((SELECT DECODE(PART_CANCEL_YN,'Y','1','0') 
							FROM TOR_ORDER  O,
							   TDE_DELI_MST  DM
							WHERE O.FIRST_ORDER_ID = DM.ORDER_ID
							   AND O.ORDER_ID = OI.ORDER_ID
							   AND DM.DELI_DIVN_CD ='10' --주문정상
							   AND DM.INVOICE_STATUS_CD = '10' --송장정상
							   AND DM.DELI_TYPE_CD IN ('01','02','03','08') -- 근거리/자사택배/픽업/해외배송만
							   AND DM.DELI_DIVN_DTL_CD ='11' -- 배송지시만
							   AND OI.POS_NO IN(SELECT POS_NO FROM TET_TLOG_POS 
												WHERE SALE_TYPE  = '4')
							   LIMIT 1 ),'0') AS PART_CANCEL_CNT
			  ,CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN
						 (CASE WHEN FN_GET_TR_TYPE( TT.WORKSTATIONID ) = '3'
						 THEN (OI.ORD_AMT)
						 ELSE (OI.ORD_AMT) * -1  END) ELSE 0 END AS ORDER_AMT
			  ,CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN
						 (CASE WHEN FN_GET_TR_TYPE( TT.WORKSTATIONID ) = '4' THEN (OI.ORD_QTY) * OI.CURR_SELL_PRC ELSE 0 END) ELSE 0 END AS CANCEL_ORDER_AMT

			  ,CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN
						(CASE WHEN FN_GET_TR_TYPE( TT.WORKSTATIONID ) = '3' THEN (OI.ORD_AMT) ELSE ((OI.ORD_AMT)) * -1  END) ELSE 0 END AS TOTAL_ORDER_AMT
			  ,CASE WHEN FN_GET_TR_TYPE( TT.WORKSTATIONID ) = '3' THEN  OI.ORD_QTY  ELSE (OI.ORD_QTY - OI.ACCEPT_QTY) * -1 END AS SALE_QTY
			  ,CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN
						 (CASE WHEN FN_GET_TR_TYPE( TT.WORKSTATIONID ) = '4' THEN OI.ORD_QTY  ELSE 0 END) ELSE 0 END AS CANCEL_SALE_QTY
			  ,CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN  OI.EXTRA_QTY ELSE 0 END AS EXTRA_QTY
			  ,CASE WHEN OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13') THEN OI.CURR_SELL_PRC ELSE 0 END AS SALE_AMT
			  ,CASE WHEN FN_GET_TR_TYPE( TT.WORKSTATIONID ) = '3' THEN (SELECT TOT_SELL_AMT FROM TOR_ORDER_ITEM A
														 WHERE A.ORDER_ID = TT.ORDER_ID AND A.STR_VENDOR_ID = OI.STR_VENDOR_ID
														   AND A.ORD_ITEM_DIVN_CD IN ('11','12','13')
														   AND A.ORDER_ITEM_SEQ = OI.ORDER_ITEM_SEQ) 
					ELSE (SELECT TOT_SELL_AMT FROM TOR_ORDER_ITEM A
														 WHERE A.ORDER_ID = TT.ORDER_ID AND A.STR_VENDOR_ID = OI.STR_VENDOR_ID
														   AND A.ORD_ITEM_DIVN_CD IN ('11','12','13')
														   AND A.ORDER_ITEM_SEQ = OI.ORDER_ITEM_SEQ) * -1 END AS SALE_DELIVERY_AMT
			  ,EN.CUPON_COM_AMT+EN.CARD_COM_AMT AS DC_AMT
			  ,EN.CUPON_VEN_AMT AS CUPON_VEN_AMT 
			  ,EN.CUPON_COM_AMT AS CUPON_COM_AMT 
			  ,EN.CARD_VEN_AMT AS CARD_VEN_AMT 
			  ,EN.CARD_COM_AMT AS CARD_COM_AMT 
			  ,EN.CARDCO_CARD_COM_AMT AS CARDCO_CARD_COM_AMT 
			  ,EN.MILEAGE_DIV_AMT AS MILEAGE_DIV_AMT 
			  ,EN.BANN_DIV_AMT AS BANN_DIV_AMT 
			  ,EN.DELIVERY_DIV_AMT -- 매출 배송비
			  ,EN.ORDER_SEQ
		  FROM TOR_ORDER_ITEM  OI
		INNER JOIN TSA_TLOGSELECT  TT 
				ON TT.RETAILSTOREID IN ('981', '309', PG_UTIL.FN_GET_FEDAY_MALL_STR_CD())
			   AND TT.BUSINESSDAYDATE BETWEEN #frDt# AND #toDt#
			   AND TT.RECORDQUALIFIER = '5'
			   AND SUBSTR(TT.WORKSTATIONID, 1, 2) IN ('83', '85', '84', '86')
			   AND TT.TRANSTYPECODE NOT IN ('0050', '0060')
			   AND TT.IF_LOAD_YN = 'Y'  /* IF 적재여부 TSA_TLOGSELECT_3 */
			   AND OI.ORDER_ID = TT.ORDER_ID 
			   AND OI.ORDER_ITEM_SEQ = TT.ORDER_ITEM_SEQ
		INNER JOIN TSA_TLOGSELECT  TTX  /* TPR_PRODUCT 의 과면세 구분을 사용하면 안되서 추가함 */
				ON TTX.RETAILSTOREID IN ('981', '309', PG_UTIL.FN_GET_FEDAY_MALL_STR_CD())
			   AND TTX.BUSINESSDAYDATE BETWEEN #frDt# AND #toDt#
			   AND TTX.RECORDQUALIFIER = '13'
			   AND SUBSTR(TTX.WORKSTATIONID, 1, 2) IN ('83', '85', '84', '86')
			   AND TTX.TRANSTYPECODE NOT IN ('0050', '0060')
			   AND TTX.IF_LOAD_YN = 'Y'  /* IF 적재여부 TSA_TLOGSELECT_3 */
			   AND OI.ORDER_ID = TTX.ORDER_ID 
			   AND OI.ORDER_ITEM_SEQ = TTX.ORDER_ITEM_SEQ
		INNER JOIN TPR_PRODUCT  PD
				ON OI.PROD_CD = PD.PROD_CD
		INNER JOIN TVE_VENDOR  VD
				ON PD.VENDOR_ID = VD.VENDOR_ID
		INNER JOIN V_CA_MD_CATEGORY  VC
				ON PD.CAT_CD = VC.L3_CD
		INNER JOIN  /*에누리 금액*/
					(SELECT SS_S.ORDER_ID
							,SS_S.ORDER_ITEM_SEQ 
							,SUM(SS_S.CUPON_DIV_AMT) AS CUPON_VEN_AMT   /* 쿠폰 타사 분담금*/
							,SUM(SS_S.CPN_COM_SHCH) AS CUPON_COM_AMT /*쿠폰 자사 분담금*/
							,SUM(SS_S.CARD_CARDCO_SHCH) AS CARD_VEN_AMT /*카드 타사 분담금*/
							,SUM(SS_S.CARD_COM_SHCH) AS CARD_COM_AMT /*카드 자사 분담금 */
							, 0 AS CARDCO_CARD_COM_AMT /*카드사 분담금 */
							,SUM(SS_S.MILEAGE_DIV_AMT)  AS MILEAGE_DIV_AMT /* 마일리지*/ 
							, 0 AS BANN_DIV_AMT -- 배너광고비
							,SUM(SS_S.DELIVERY_AMT) + SUM(NVL(SS_S.DELIVERY_COUPON_AMT,0)) AS DELIVERY_DIV_AMT /* 매출 배송비 */
							, '1'  AS ORDER_SEQ
						FROM TRST_SUBSTN_PROD_LOG  SS_S
							 , TVE_VENDOR  VD_S
							 , TPR_PRODUCT  PD_S
						WHERE  SS_S.PROD_CD  = PD_S.PROD_CD
							AND SS_S.SALE_DY BETWEEN #frDt# AND #toDt#
							<isNotEmpty property="vendorId">
							AND VD_S.SALE_VENDOR_ID = #vendorId#  /* 협력업체코드*/
							</isNotEmpty>
							AND  SS_S.VENDOR_ID = VD_S.VENDOR_ID 
						 GROUP BY SS_S.ORDER_ID, SS_S.ORDER_ITEM_SEQ 
				   ) EN
				ON OI.ORDER_ID = EN.ORDER_ID
			   AND OI.ORDER_ITEM_SEQ = EN.ORDER_ITEM_SEQ
		  WHERE (     OI.ORD_ITEM_DIVN_CD NOT IN ('11','12','13')
                 AND VD.VENDOR_KIND_CD = 'KM05'
                 <isNotEmpty property="vendorId">
                 AND VD.SALE_VENDOR_ID = #vendorId# /* 협력업체코드*/
                 </isNotEmpty>
                 <isNotEmpty property="catCd">
                 AND  VC.L1_CD = #catCd# /* 분류*/
                 </isNotEmpty>
                )
            OR (     OI.ORD_ITEM_DIVN_CD IN ('11','12','13')
                 AND VD.VENDOR_KIND_CD = 'KM01'
                 AND VD.SALE_VENDOR_ID = '999002' /* (주)롯데쇼핑 / 배송비상품 */
                 <isNotEmpty property="catCd">
                 AND  VC.L1_CD = #catCd# /* 분류*/
                 </isNotEmpty>
               )
		)X
    </select>

</sqlMap>