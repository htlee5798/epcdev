<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
    
<sqlMap namespace="NEDMPRO0330">
	<typeAlias alias="nEDMPRO0330VO"    	type="com.lottemart.epc.edi.product.model.NEDMPRO0330VO" />		<!-- 약정서 조회 VO -->

	<!-- 반품 약정서 목록 조회 -->
	<resultMap id="selectProdRtnCntrListMap"		class="nEDMPRO0330VO">
		<result column="CON_NO"				property="conNo" 			/>	<!-- I/F 연계계약번호 -->
		<result column="DC_NUM"				property="dcNum" 			/>  <!-- ECS계약번호 -->
		<result column="DC_STAT"			property="dcStat" 			/>  <!-- 계약진행상태 -->
		<result column="DC_STAT_TXT"		property="dcStatTxt" 		/>  <!-- 계약진행상태명 -->
		<result column="LIFNR"				property="lifnr" 			/>  <!-- 공급업체 계정 번호 -->
		<result column="VEN_NM"				property="venNm" 			/>  <!-- 공급업체 계정 번호명 -->
		<result column="DEP_CD"				property="depCd" 			/>  <!-- 부서코드 -->
		<result column="TEAM_NM"			property="teamNm" 			/>  <!-- 팀명 -->
		<result column="EKORG"				property="ekorg" 			/>  <!-- 구매조직 -->
		<result column="APPR_FG"			property="apprFg" 			/>  <!-- 전자결재 상태 -->
		<result column="APPR_FG_NM"			property="apprFgNm" 		/>  <!-- 전자결재 상태명 -->
		<result column="ZRTDATE"			property="zrtdate" 			/>  <!-- MD 협의요청일 -->
		<result column="MOD_DATE"			property="modDate" 			/>  <!-- 수정일시 -->
		<result column="MOD_ID"				property="modId" 			/>  <!-- 수정자 -->
		<result column="REG_DATE"			property="regDate" 			/>  <!-- 등록일시 -->
		<result column="REG_ID"				property="regId" 			/>  <!-- 등록자 -->
    </resultMap>

	<!-- 반품 약정서 조회( 상품별 ) -->
	<resultMap id="selectProdRtnCntrProdListMap"		class="nEDMPRO0330VO">
		<result column="CON_NO"				property="conNo"			/>	<!-- I/F 연계계약번호 -->
		<result column="SEQ"				property="seq"				/>  <!-- SEQ -->
		<result column="PROD_CD"			property="prodCd" 			/>  <!-- 상품코드 -->
		<result column="PROD_NM"			property="prodNm" 			/>  <!-- 상품명 -->
		<result column="EAN11"				property="ean11"			/>  <!-- 국제물품번호(EAN/UPC) -->
		<result column="ZZPROD_STD"			property="zzprodStd"		/>  <!-- 규격 -->
		<result column="NETPR"				property="netpr"			/>  <!-- 단가 -->
		<result column="MENGE"				property="menge"			/>  <!-- 수량 -->
		<result column="DMBTR"				property="dmbtr"			/>  <!-- 금액 -->
		<result column="MOD_DATE"			property="modDate" 			/>  <!-- 수정일시 -->
		<result column="MOD_ID"				property="modId" 			/>  <!-- 수정자 -->
		<result column="REG_DATE"			property="regDate" 			/>  <!-- 등록일시 -->
		<result column="REG_ID"				property="regId" 			/>  <!-- 등록자 -->
    </resultMap>

	<!-- 반품 약정서 조회( 점포 & 상품별 ) -->
	<resultMap id="selectProdRtnCntrStrProdListMap"		class="nEDMPRO0330VO">
		<result column="CON_NO"			property="conNo" 			/>	<!-- I/F 연계계약번호 -->
		<result column="SEQ"			property="seq" 				/>  <!-- SEQ -->
		<result column="MAT_SEQ"		property="matSeq" 			/>  <!-- 자재순번 -->
		<result column="WERKS"			property="werks" 			/>  <!-- 플랜트 -->
		<result column="PROD_CD"		property="prodCd" 			/>  <!-- 상품코드 -->
		<result column="PROD_NM"		property="prodNm" 			/>  <!-- 상품명 -->
		<result column="EAN11"			property="ean11" 			/>  <!-- 국제물품번호(EAN/UPC) -->
		<result column="ZZPROD_STD"		property="zzprodStd" 		/>  <!-- 규격 -->
		<result column="NETPR"			property="netpr" 			/>  <!-- 단가 -->
		<result column="MENGE"			property="menge" 			/>  <!-- 수량 -->
		<result column="DMBTR"			property="dmbtr" 			/>  <!-- 금액 -->
		<result column="DC_STAT"		property="dcStat" 			/>  <!-- 계약진행상태 -->
		<result column="ZRETYP"			property="zretyp" 			/>  <!-- 반품사유 -->
		<result column="ZRETYP_NM"		property="zretypNm" 		/>  <!-- 반품사유명 -->
		<result column="ZRETYP_D"		property="zretypD" 			/>  <!-- 반품상세사유 -->
		<result column="ZRETYP_D_NM"	property="zretypDNm" 		/>  <!-- 반품상세사유명 -->
		<result column="ZRELOC"			property="zreloc" 			/>  <!-- 반품장소 -->
		<result column="ZRELOC_NM"		property="zrelocNm" 		/>  <!-- 반품장소명 -->
		<result column="MOD_DATE"		property="modDate" 			/>  <!-- 수정일시 -->
		<result column="MOD_ID"			property="modId" 			/>  <!-- 수정자 -->
		<result column="REG_DATE"		property="regDate" 			/>  <!-- 등록일시 -->
		<result column="REG_ID"			property="regId" 			/>  <!-- 등록자 -->
    </resultMap>
    
	<!-- 반품 약정서 MERGE -->
	 <insert id="mergeProdRtnCntr" parameterClass="hashmap">	  
    	/*NEDMPRO0330.mergeProdRtnCntr*/
    	MERGE INTO TPC_PROD_RTN_CNTR A
			USING (
				SELECT
					#CON_NO#	AS conNo		/* if 연계계약번호 */
			) B
				ON ( A.con_no = b.conNo)
			WHEN MATCHED THEN
				UPDATE SET
					  MOD_DATE      = NOW()   
					, MOD_ID        = #workId#
					<isNotEqual property="DC_NUM" compareValue="">
					, DC_NUM		= #DC_NUM#
					</isNotEqual>
					<isNotEqual property="DC_STAT" compareValue="">
					, DC_STAT		= #DC_STAT#
					</isNotEqual>
					<isNotEqual property="DC_STAT_TXT" compareValue="">
					, DC_STAT_TXT	= #DC_STAT_TXT#
					</isNotEqual>
					<isNotEqual property="LIFNR" compareValue="">
					, LIFNR			= #LIFNR#
					</isNotEqual>
					<isNotEqual property="DEP_CD" compareValue="">
					, DEP_CD		= #DEP_CD#
					</isNotEqual>
					<isNotEqual property="EKORG" compareValue="">
					, EKORG			= #EKORG#
					</isNotEqual>
					<isNotEqual property="APPR_FG" compareValue="">
					, APPR_FG		= #APPR_FG#
					</isNotEqual>
					<isNotEqual property="APPR_FG_NM" compareValue="">
					, APPR_FG_NM	= #APPR_FG_NM#
					</isNotEqual>
					<isNotEqual property="ZRTDATE" compareValue="">
					, ZRTDATE	= #ZRTDATE#
					</isNotEqual>
             WHEN NOT MATCHED THEN                                                                  
				INSERT (
					  CON_NO
					<isNotEqual property="DC_NUM" compareValue="">
					, DC_NUM
					</isNotEqual>
					<isNotEqual property="DC_STAT" compareValue="">
					, DC_STAT
					</isNotEqual>
					<isNotEqual property="DC_STAT_TXT" compareValue="">
					, DC_STAT_TXT
					</isNotEqual>
					<isNotEqual property="LIFNR" compareValue="">
					, LIFNR
					</isNotEqual>
					<isNotEqual property="DEP_CD" compareValue="">
					, DEP_CD
					</isNotEqual>
					<isNotEqual property="EKORG" compareValue="">
					, EKORG
					</isNotEqual>
					<isNotEqual property="APPR_FG" compareValue="">
					, APPR_FG
					</isNotEqual>
					<isNotEqual property="APPR_FG_NM" compareValue="">
					, APPR_FG_NM
					</isNotEqual>
					<isNotEqual property="ZRTDATE" compareValue="">
					, ZRTDATE
					</isNotEqual>
					, MOD_DATE
					, MOD_ID
					, REG_DATE
					, REG_ID
				) values (
					 #CON_NO#
					<isNotEqual property="DC_NUM" compareValue="">
					, #DC_NUM#
					</isNotEqual>
					<isNotEqual property="DC_STAT" compareValue="">
					, #DC_STAT#
					</isNotEqual>
					<isNotEqual property="DC_STAT_TXT" compareValue="">
					, #DC_STAT_TXT#
					</isNotEqual>
					<isNotEqual property="LIFNR" compareValue="">
					, #LIFNR#
					</isNotEqual>
					<isNotEqual property="DEP_CD" compareValue="">
					, #DEP_CD#
					</isNotEqual>
					<isNotEqual property="EKORG" compareValue="">
					, #EKORG#
					</isNotEqual>
					<isNotEqual property="APPR_FG" compareValue="">
					, #APPR_FG#
					</isNotEqual>
					<isNotEqual property="APPR_FG_NM" compareValue="">
					, #APPR_FG_NM#
					</isNotEqual>
					<isNotEqual property="ZRTDATE" compareValue="">
					, #ZRTDATE#
					</isNotEqual>
					, NOW()
					, #workId#
					, NOW()
					, #workId#
				);
 	</insert>

	<!-- 반품 약정서 상품별 MERGE -->
	<insert id="mergeProdRtnCntrProd" parameterClass="hashmap">	  
    	/*NEDMPRO0330.mergeProdRtnCntrProd*/
    	MERGE INTO TPC_PROD_RTN_CNTR_PROD A
			USING (
				SELECT
					#CON_NO#	AS conNo		/* if 연계계약번호 */
					, #MATNR#	AS prodCd		/* 순번	*/
			) B
				ON ( A.con_no = b.conNo AND A.prod_cd = B.prodCd)
			WHEN MATCHED THEN
				UPDATE SET
					  MOD_DATE      = NOW()   
					, MOD_ID        = #workId#
					<isNotEqual property="SEQ" compareValue="">
					, SEQ    	  = #SEQ#
					</isNotEqual>
					<isNotEqual property="EAN11" compareValue="">
					, EAN11       = #EAN11#
					</isNotEqual>
					<isNotEqual property="ZZPROD_STD" compareValue="">
					, ZZPROD_STD  = #ZZPROD_STD#
					</isNotEqual>
					<isNotEqual property="NETPR" compareValue="">
					, NETPR       = #NETPR#
					</isNotEqual>
					<isNotEqual property="MENGE" compareValue="">
					, MENGE       = #MENGE#
					</isNotEqual>
					<isNotEqual property="DMBTR" compareValue="">
					, DMBTR       = #DMBTR#
					</isNotEqual>
             WHEN NOT MATCHED THEN                                                                  
				INSERT (
					  CON_NO
					, PROD_CD
					<isNotEqual property="SEQ" compareValue="">
					, SEQ
					</isNotEqual>
					<isNotEqual property="EAN11" compareValue="">
					, EAN11
					</isNotEqual>
					<isNotEqual property="ZZPROD_STD" compareValue="">
					, ZZPROD_STD
					</isNotEqual>
					<isNotEqual property="NETPR" compareValue="">
					, NETPR
					</isNotEqual>
					<isNotEqual property="MENGE" compareValue="">
					, MENGE
					</isNotEqual>
					<isNotEqual property="DMBTR" compareValue="">
					, DMBTR
					</isNotEqual>
					, MOD_DATE
					, MOD_ID
					, REG_DATE
					, REG_ID
				) values (
					 #CON_NO#
					, #MATNR#
					<isNotEqual property="SEQ" compareValue="">
					,#SEQ#
					</isNotEqual>
					<isNotEqual property="EAN11" compareValue="">
					, #EAN11#
					</isNotEqual>
					<isNotEqual property="ZZPROD_STD" compareValue="">
					, #ZZPROD_STD#
					</isNotEqual>
					<isNotEqual property="NETPR" compareValue="">
					, #NETPR#
					</isNotEqual>
					<isNotEqual property="MENGE" compareValue="">
					, #MENGE#
					</isNotEqual>
					<isNotEqual property="DMBTR" compareValue="">
					, #DMBTR#
					</isNotEqual>
					, NOW()
					, #workId#
					, NOW()
					, #workId#
				);
 	</insert>
	
	<!-- 반품 약정서 점포&상품별 MERGE -->
	 <insert id="mergeProdRtnCntrStrProd" parameterClass="hashmap">	  
    	/*NEDMPRO0330.mergeProdRtnCntrStrProd*/
    	MERGE INTO TPC_PROD_RTN_CNTR_STR_PROD A
			USING (
				SELECT
					#CON_NO#	AS conNo		/* if 연계계약번호 */
					, #WERKS#	AS werks		/* 플랜트	*/
					, #MATNR# as prodCd			/* 상품코드 */
			) B
				ON ( A.CON_NO = b.conNo AND A.WERKS = B.werks AND A.PROD_CD = B.prodCd)
			WHEN MATCHED THEN
				UPDATE SET
					  MOD_DATE      = NOW()   
					, MOD_ID        = #workId#
					<isNotEqual property="SEQ" compareValue="">
					, SEQ    	  	= #SEQ#
					</isNotEqual>
					<isNotEqual property="EAN11" compareValue="">
					, EAN11         = #EAN11#
					</isNotEqual>
					<isNotEqual property="ZZPROD_STD" compareValue="">
					, ZZPROD_STD    = #ZZPROD_STD#
					</isNotEqual>
					<isNotEqual property="NETPR" compareValue="">
					, NETPR         = #NETPR#
					</isNotEqual>
					<isNotEqual property="MENGE" compareValue="">
					, MENGE         = #MENGE#
					</isNotEqual>
					<isNotEqual property="DMBTR" compareValue="">
					, DMBTR         = #DMBTR#
					</isNotEqual>
					<isNotEqual property="DC_STAT" compareValue="">
					, DC_STAT       = #DC_STAT#
					</isNotEqual>
					<isNotEqual property="ZRETYP" compareValue="">
					, ZRETYP        = #ZRETYP#
					</isNotEqual>
					<isNotEqual property="ZRETYP_D" compareValue="">
					, ZRETYP_D      = #ZRETYP_D#
					</isNotEqual>
					<isNotEqual property="ZRELOC" compareValue="">
					, ZRELOC        = #ZRELOC#
					</isNotEqual>
             WHEN NOT MATCHED THEN                                                                  
				INSERT (
					  CON_NO
					, WERKS
					, PROD_CD
					<isNotEqual property="SEQ" compareValue="">
					, SEQ
					</isNotEqual>
					<isNotEqual property="MAT_SEQ" compareValue="">
					, MAT_SEQ
					</isNotEqual>
					<isNotEqual property="EAN11" compareValue="">
					, EAN11
					</isNotEqual>
					<isNotEqual property="ZZPROD_STD" compareValue="">
					, ZZPROD_STD
					</isNotEqual>
					<isNotEqual property="NETPR" compareValue="">
					, NETPR
					</isNotEqual>
					<isNotEqual property="MENGE" compareValue="">
					, MENGE
					</isNotEqual>
					<isNotEqual property="DMBTR" compareValue="">
					, DMBTR
					</isNotEqual>
					<isNotEqual property="DC_STAT" compareValue="">
					, DC_STAT
					</isNotEqual>
					<isNotEqual property="ZRETYP" compareValue="">
					, ZRETYP
					</isNotEqual>
					<isNotEqual property="ZRETYP_D" compareValue="">
					, ZRETYP_D
					</isNotEqual>
					<isNotEqual property="ZRELOC" compareValue="">
					, ZRELOC
					</isNotEqual>
					, MOD_DATE
					, MOD_ID
					, REG_DATE
					, REG_ID
				) values (
					  #CON_NO#
					, #WERKS#  
					, #MATNR#
					<isNotEqual property="SEQ" compareValue="">
					, #SEQ#
					</isNotEqual>
					<isNotEqual property="MAT_SEQ" compareValue="">
					, #MAT_SEQ#
					</isNotEqual>
					<isNotEqual property="EAN11" compareValue="">
					, #EAN11#
					</isNotEqual>
					<isNotEqual property="ZZPROD_STD" compareValue="">
					, #ZZPROD_STD#
					</isNotEqual>
					<isNotEqual property="NETPR" compareValue="">
					, #NETPR#
					</isNotEqual>
					<isNotEqual property="MENGE" compareValue="">
					, #MENGE#
					</isNotEqual>
					<isNotEqual property="DMBTR" compareValue="">
					, #DMBTR#
					</isNotEqual>
					<isNotEqual property="DC_STAT" compareValue="">
					, #DC_STAT#
					</isNotEqual>
					<isNotEqual property="ZRETYP" compareValue="">
					, #ZRETYP#
					</isNotEqual>
					<isNotEqual property="ZRETYP_D" compareValue="">
					, #ZRETYP_D#
					</isNotEqual>
					<isNotEqual property="ZRELOC" compareValue="">
					, #ZRELOC#
					</isNotEqual>
					, NOW()
					, #workId#
					, NOW()
					, #workId#
				);
 	</insert>
	
	<!-- 반품 약정서 목록 조회 -->
	<select id="selectProdRtnCntrList" resultMap="selectProdRtnCntrListMap" parameterClass="nEDMPRO0330VO">
	/* NEDMPRO0330.selectProdRtnCntrList */
	    SELECT 
			  A.CON_NO					/* I/F 연계계약번호 */
			, A.DC_NUM                  /* ECS계약번호 */
			, A.DC_STAT                 /* 계약진행상태 */
			, A.DC_STAT_TXT             /* 계약진행상태명 */
			, A.LIFNR                   /* 공급업체 계정 번호 */
			, B.VEN_NM                  /* 공급업체명 */
			, A.DEP_CD                  /* 부서코드 */
			, C.TEAM_NM                 /* 팀명 */
			, A.EKORG                   /* 구매조직 */
			, A.APPR_FG                 /* 전자결재 상태 */
			, A.APPR_FG_NM              /* 전자결재 상태명 */
			, TO_CHAR(CAST(A.ZRTDATE AS TIMESTAMP), 'YYYY-MM-DD') AS ZRTDATE     /* MD 협의요청일	*/
			, TO_CHAR(A.MOD_DATE,'YYYY-MM-DD') AS MOD_DATE     /* 수정일시	*/
			, MOD_ID                    /* 수정자			*/
			, TO_CHAR(A.REG_DATE,'YYYY-MM-DD') AS REG_DATE     /* 등록일시	*/
			, REG_ID                    /* 등록자			*/
		FROM TPC_PROD_RTN_CNTR A
		LEFT JOIN HQ_VEN B ON A.LIFNR = B.VEN_CD
		LEFT JOIN 
		(
			SELECT 	TEAM_CD
				,	TEAM_NM
			FROM TPC_L1_CD_BAK_250526
			GROUP BY TEAM_CD, TEAM_NM
		)C ON A.DEP_CD = C.TEAM_CD
		WHERE A.ZRTDATE BETWEEN TO_CHAR(CAST(#iRgdatFrom# AS TIMESTAMP), 'YYYYMMDD') AND TO_CHAR(CAST(#iRgdatTo# AS TIMESTAMP), 'YYYYMMDD')
		<isNotEqual property="iDepCd" compareValue="">
			AND A.DEP_CD = #iDepCd#
		</isNotEqual>
		<isNotEqual property="iDcStat" compareValue="">
			AND A.DC_STAT = #iDcStat#
		</isNotEqual>
		<isNotEqual property="iLifnr" compareValue="">
			AND A.LIFNR = #iLifnr#
		</isNotEqual>
	</select>
	
	<!-- 반품 약정서 조회( 상품별 ) -->
	<select id="selectProdRtnCntrProdList" resultMap="selectProdRtnCntrProdListMap" parameterClass="nEDMPRO0330VO">
	/* NEDMPRO0330.selectProdRtnCntrProdList */
	    SELECT 
			  A.CON_NO					  /* I/F 연계계약번호 */
			, A.SEQ                       /* SEQ */
			, A.PROD_CD                   /* 상품코드 */
			, B.PROD_NM					  /* 상품명 */
			, A.EAN11                     /* 국제물품번호(EAN/UPC) */
			, A.ZZPROD_STD                /* 규격 */
			, A.NETPR                     /* 단가 */
			, A.MENGE                     /* 수량 */
			, A.DMBTR                     /* 금액 */
			, TO_CHAR(A.MOD_DATE,'YYYY-MM-DD') AS MOD_DATE     /* 수정일시	*/
			, MOD_ID                    /* 수정자			*/
			, TO_CHAR(A.REG_DATE,'YYYY-MM-DD') AS REG_DATE     /* 등록일시	*/
			, REG_ID                    /* 등록자			*/
		FROM TPC_PROD_RTN_CNTR_PROD A
		LEFT JOIN PRODUCT B ON A.PROD_CD = B.PROD_CD
		WHERE CON_NO = #conNo#
		ORDER BY A.SEQ
	</select>
	
	<!-- 반품 약정서 조회( 점포 & 상품 ) -->
	<select id="selectProdRtnCntrStrProdList" resultMap="selectProdRtnCntrStrProdListMap" parameterClass="nEDMPRO0330VO">
	/* NEDMPRO0330.selectProdRtnCntrStrProdList */
	    SELECT 
			  A.CON_NO		  /* I/F 연계계약번호 */
			, A.SEQ           /* SEQ */
			, A.MAT_SEQ       /* 자재순번 */
			, A.WERKS         /* 플랜트 */
			, A.PROD_CD       /* 상품코드 */
			, B.PROD_NM		  /* 상품명 */
			, A.EAN11         /* 국제물품번호(EAN/UPC) */
			, A.ZZPROD_STD    /* 규격 */
			, A.NETPR         /* 단가 */
			, A.MENGE         /* 수량 */
			, A.DMBTR         /* 금액 */
			, A.DC_STAT       /* 계약진행상태 */
			, A.ZRETYP        /* 반품사유 */
			, FN_NEW_CODE_RTN('RTRSN',A.ZRETYP) AS ZRETYP_NM		/* 반품사유명 */
			, A.ZRETYP_D      /* 반품상세사유 */
			, FN_NEW_CODE_RTN('RTRSD',A.ZRETYP_D) AS ZRETYP_D_NM	/* 반품상세사유명 */
			, A.ZRELOC        /* 반품장소 */
			, FN_NEW_CODE_RTN('RTPLC',A.ZRELOC) AS ZRELOC_NM		/* 반품장소명 */
			, TO_CHAR(A.MOD_DATE,'YYYY-MM-DD') AS MOD_DATE     /* 수정일시	*/
			, A.MOD_ID                    /* 수정자			*/
			, TO_CHAR(A.REG_DATE,'YYYY-MM-DD') AS REG_DATE     /* 등록일시	*/
			, A.REG_ID                    /* 등록자			*/
		FROM TPC_PROD_RTN_CNTR_STR_PROD A
		LEFT JOIN PRODUCT B ON A.PROD_CD = B.PROD_CD
		WHERE CON_NO = #conNo#
		ORDER BY A.SEQ
	</select>
	
	
	
</sqlMap>	
