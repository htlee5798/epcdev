<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="NEDMWEB0099">

<typeAlias alias="resultClass"		type="lcn.module.common.util.HashBox" />
<typeAlias alias="paramClass"		type="lcn.module.common.util.HashBox" />
<typeAlias alias="nEDMWEB0099VO" type="com.lottemart.epc.edi.weborder.model.NEDMWEB0099VO" />
<typeAlias alias="searchWebOrder"	type="com.lottemart.epc.edi.weborder.model.SearchWebOrder"/>
<typeAlias alias="ediEmpPool"  		type="com.lottemart.epc.edi.weborder.model.EdiPoEmpPoolVO" />
<typeAlias alias="ediVendor"  		type="com.lottemart.epc.edi.weborder.model.EdiVendorVO" />
<typeAlias alias="ediRtnProd"  		type="com.lottemart.epc.edi.weborder.model.EdiRtnProdVO" />
<typeAlias alias="tedStore"  		type="com.lottemart.epc.edi.weborder.model.TedStore" />


  
 
  	<!-- MDer 사원정보 조회 EDI_EMP_POOL_LIST_01 -->
	<resultMap id="ediEmpPoolListMap"	class="ediEmpPool">
    	<result property="empNo"			column="EMP_NO"			/>	<!-- 사원번호    	 -->
		<result property="empNm"      		column="EMP_NM"         />	<!-- 사원명        -->
		<result property="orgCd"      		column="ORG_CD"         />	<!-- MD부서코드    -->
		<result property="orgNm"      		column="ORG_NM"         />	<!-- MD부서명      -->
		<result property="mail"       		column="MAIL"           />	<!-- 메일          -->
		<result property="jobCd"      		column="JOB_CD"         />	<!-- 직무코드      -->
		<result property="jobNm"      		column="JOB_NM"         />	<!-- 직무명        -->
		<result property="phoneNo"    		column="PHONE_NO"       />	<!-- 사무실번호    -->
		<result property="hpNo"       		column="HP_NO"          />	<!-- 핸드폰번호    -->
		<result property="regDt"      		column="REG_DT"         />	<!-- 등록일        -->
		<result property="lstChgDt"   		column="LST_CHG_DT"     />	<!-- 수정일        -->
		<result property="chgFg"      		column="CHG_FG"         />	<!-- 수정구분      -->
  	</resultMap>
  	
	
	<!-- 업체찾기 공통 selectVendCodeList  -->
	<resultMap id="ediVendorMap" class="ediVendor">
  		 <result property="venCd"    	  column="VEN_CD"      />	<!--업체코드        -->
         <result property="venNm"         column="VEN_NM"      />	<!--업체명          -->
         <result property="bmanNo"        column="BMAN_NO"     />	<!--사업자번호      -->
         <result property="bmanNoFmt"     column="BMAN_NO_FMT" />	<!--사업자번호 패턴 -->
         <result property="btyp"          column="BTYP"        />	<!--업태            -->
         <result property="bkind"         column="BKIND"       />	<!--업종            -->
         <result property="addr1"         column="ADDR1"       />	<!--주소1          -->
         <result property="addr2"         column="ADDR2"       />	<!--주소2          -->
         <result property="repTelNo"      column="REP_TEL_NO"  />	<!--대표전화        -->
         <result property="presidNm"      column="PRESID_NM"   />	<!--대표자명        -->
	</resultMap> 
	
	
	<!-- 반품 상품 조회 EDI_RETURN_PROD_DATA_01 -->
	<resultMap id="ediRtnProdMap"	class="ediRtnProd">
    	<result property="prodCd"				column="PROD_CD"				/>	<!-- 상품코드     -->
		<result property="srcmkCd"    			column="SRCMK_CD"				/>	<!-- 판매코드     -->
		<result property="prodNm"     			column="PROD_NM"				/>	<!-- 상품명       -->
		<result property="prodStd"    			column="PROD_STD"				/>	<!-- 상품규격     -->
		<result property="venCd"	    		column="VEN_CD"					/>	<!-- 업체코드     -->
		<result property="ordIpsu"    			column="ORD_IPSU"				/>	<!-- 반품입수     -->
		<result property="buyPrc"    			column="BUY_PRC"				/>	<!-- 원가    	   -->
		<result property="salePrc"    			column="SALE_PRC"				/>	<!-- 매가          -->
		<result property="rrlStkQty"            column="RRL_STK_QTY"      		/>	<!-- 재고수량	-->
  	</resultMap>
  	
	<!-- 협력사 발주가능 점포목록 조회 [ EDI_RETURN_VENDOR_STORE_SELECT_01 ] -->
	<resultMap id="ediVenStoreMap"	class="tedStore">
    	<result property="areaCd"    			column="AREA_CD"			/>	<!-- 권역코드     -->
    	<result property="areaNm"    			column="AREA_NM"			/>	<!-- 권역명칭     -->
    	<result property="strCd"    			column="STR_CD"				/>	<!-- 점포코드     -->
    	<result property="strNm"    			column="STR_NM"				/>	<!-- 점포명칭     -->
    	
    	
	</resultMap>
	
	  	
	<!-- 사원정보 조회 -->
	<select id="EDI_EMP_POOL_SELECT_01" parameterClass="nEDMWEB0099VO" resultMap="ediEmpPoolListMap">
		/*NEDMWEB0099.EDI_EMP_POOL_SELECT_01*/
		SELECT	 M1.EMP_NO			
				,M1.EMP_NM			
				,M1.ORG_CD			
				,M1.ORG_NM			
				,M1.MAIL				
				,M1.JOB_CD			
				,M1.JOB_NM			
				,M1.PHONE_NO		
				,M1.HP_NO			
				,TO_CHAR(M1.REG_DT,'YYYY-MM-DD HH24:MI')	 as REG_DT			
				,TO_CHAR(M1.LST_CHG_DT,'YYYY-MM-DD HH24:MI') as LST_CHG_DT	
				,M1.CHG_FG			
	      FROM TPC_PO_EMP_POOL M1
	     WHERE M1.EMP_NO =  #empNo#
	</select>
	
	    
	
	<!-- 협력사 정보 조회 (전체 또는 관계협력사) -->
	<select id="EDI_EMP_POOL_SELECT_02" parameterClass="nEDMWEB0099VO" resultMap="ediVendorMap">
		/*NEDMWEB0099.EDI_EMP_POOL_SELECT_02*/
		 SELECT  M2.VEN_CD        
                ,M2.VEN_NM      
                ,M2.BMAN_NO
                ,CASE WHEN M2.BMAN_NO IS NOT NULL and  LENGTH(M2.BMAN_NO) = 10  THEN
                              SUBSTR(M2.BMAN_NO,1,3)||'-'||SUBSTR(M2.BMAN_NO,4,2)||'-'||SUBSTR(M2.BMAN_NO,6)
                      ELSE  M2.BMAN_NO END AS BMAN_NO_FMT 
                ,nvl(M2.BTYP,' ') BTYP        
                ,nvl(M2.BKIND,' ') BKIND       
                ,M2.ADDR1      
                ,M2.ADDR2      
                ,M2.REP_TEL_NO 
                ,M2.PRESID_NM  
            FROM ( SELECT S1.VEN_CD    AS VEN_CD
                         ,MAX(S1.STR_CD) AS STR_CD
                     FROM TPC_VENDOR S1
                           <isEmpty property="findType" >
				                INNER JOIN TPC_PO_EMP_VENDOR S2 
				                        ON S1.TRD_TYP_FG = '2'
				                       AND S2.EMP_NO = #empNo#
				                       AND S1.VEN_CD = S2.VEN_CD
				                	   AND S1.VEN_CD = #venCd#
							</isEmpty>
							<isNotEmpty property="findType" >
								    WHERE S1.VEN_CD = #venCd#
							</isNotEmpty>                             
                        GROUP BY S1.VEN_CD        
                 ) M1 
           INNER JOIN TPC_VENDOR M2 
                   ON M1.VEN_CD = M2.VEN_CD 
                  AND M1.STR_CD = M2.STR_CD
            WHERE M2.TRD_TYP_FG = '2'      
        ORDER BY M2.VEN_NM
		 
	</select>
	
	
	
	
	<!-- 반품 상품 조회 -->
	<select id="EDI_RETURN_PROD_DATA_01" parameterClass="nEDMWEB0099VO" resultMap="ediRtnProdMap">
		/*NEDMWEB0099.EDI_RETURN_PROD-DATA-01*/     
		SELECT	 M1.PROD_CD
	          	,M1.SRCMK_CD
	          	,M1.PROD_NM
	        	,M1.PROD_STD
	        	,M1.VEN_CD
	        	,M1.ORD_IPSU
	        	,M1.BUY_PRC
	        	,M1.SALE_PRC
	        	,M1.STR_CD
	        	,CURRENT_JEGO_QTY_FNC@DL_MD_MARTNIS('0', M1.STR_CD, M1.PROD_CD, TO_CHAR(CURRENT_TIMESTAMP(0),'YYYYMMDD')) AS RRL_STK_QTY
	        FROM EDI_RTN_PROD_V1@DL_MD_MARTNIS M1 
	  	   WHERE M1.VEN_CD	= #venCd#
	    	 AND M1.PROD_CD	= #prodCd#
	    	 <isNotEmpty property="strCd">	
	    	 AND M1.STR_CD = #strCd#
	    	 </isNotEmpty>
	     GROUP BY M1.PROD_CD
	        ,M1.SRCMK_CD
	        ,M1.PROD_NM
	        ,M1.PROD_STD
	        ,M1.VEN_CD
	        ,M1.ORD_IPSU
	        ,M1.BUY_PRC
	        ,M1.SALE_PRC
	        ,M1.STR_CD
	</select>

	
	
	<!-- 관계 협력업체 목록 조회  dynamic Where 공통 (selectVendCodeList, selectVendCodeCnt) -->
	<sql id="EDI_RETURN_PROD_SELECT_Where">
	      WHERE M1.VEN_CD	= #venCd#
		    <isNotEmpty property="prodCd">		            
			  	AND PROD_CD = #prodCd#
			</isNotEmpty>
			<isNotEmpty property="srcmkCd">		            
			  	AND SRCMK_CD = #srcmkCd#
			</isNotEmpty>
		    <isNotEmpty property="prodNm">		            
		      	AND PROD_NM LIKE '%'|| #prodNm# ||'%'
			</isNotEmpty> 
	</sql>    
	
	<!-- 반품 상품 목록 조회 -->
	<select id="EDI_RETURN_PROD_SELECT_01"   parameterClass="nEDMWEB0099VO" resultMap="ediRtnProdMap">
		/*NEDMWEB0099.EDI_RETURN_PROD_SELECT_01*/
		SELECT * FROM(
		SELECT ROWNUM RNUM , A.*  FROM (
		   SELECT M1.PROD_CD
			     ,M1.SRCMK_CD
			     ,M1.PROD_NM
			     ,M1.PROD_STD
			     ,M1.VEN_CD
			     ,M1.ORD_IPSU
			     ,M1.BUY_PRC
	        	 ,M1.SALE_PRC
	        	 ,M1.STR_CD
	        	 ,CURRENT_JEGO_QTY_FNC@DL_MD_MARTNIS('0', M1.STR_CD, M1.PROD_CD, TO_CHAR(CURRENT_TIMESTAMP(0),'YYYYMMDD')) AS RRL_STK_QTY
		    FROM EDI_RTN_PROD_V1@DL_MD_MARTNIS M1
			 <include refid="NEDMWEB0099.EDI_RETURN_PROD_SELECT_Where"/>		
			GROUP BY M1.PROD_CD
			        ,M1.SRCMK_CD
			        ,M1.PROD_NM
			        ,M1.PROD_STD
			        ,M1.VEN_CD
			        ,M1.ORD_IPSU
			        ,M1.BUY_PRC
	        	    ,M1.SALE_PRC
	        	    ,M1.STR_CD
			 ORDER BY M1.PROD_CD ASC
		)A)A
	</select>
	
	<!-- 반품 상품 목록 조회 PAGE COUNT -->
	<select id="EDI_RETURN_PROD_SELECT_02"   parameterClass="nEDMWEB0099VO"  resultClass="int">
		/*NEDMWEB0099.EDI_RETURN_PROD_SELECT_02*/
		SELECT COUNT(*) CNT FROM(
		   SELECT M1.PROD_CD
			     ,M1.SRCMK_CD
			     ,M1.PROD_NM
			     ,M1.PROD_STD
			     ,M1.VEN_CD
			     ,M1.ORD_IPSU
		    FROM EDI_RTN_PROD_V1@DL_MD_MARTNIS M1
			<include refid="NEDMWEB0099.EDI_RETURN_PROD_SELECT_Where"/>
			GROUP BY M1.PROD_CD
			        ,M1.SRCMK_CD
			        ,M1.PROD_NM
			        ,M1.PROD_STD
			        ,M1.VEN_CD
			        ,M1.ORD_IPSU
		)
	</select>
	
	<!-- 발주가능 점포 목록 조회  -->
	<select id="EDI_RETURN_VENDOR_STORE_SELECT_01"   parameterClass="nEDMWEB0099VO" resultMap="ediVenStoreMap">
		/*NEDMWEB0099.EDI_RETURN_VENDOR_STORE_SELECT_01*/
	    SELECT  T1.AREA_FG    AS AREA_CD
		       ,T2.CD_NM  AS AREA_NM	
		       ,T1.STR_CD
               ,T1.STR_NM
	      FROM TPC_ORD_SUPP_INFO T0
	       INNER JOIN STORE T1 
	                    ON T0.STR_CD = T1.STR_CD
	       INNER JOIN TPC_CODE T2
	               ON T2.MAJOR_CD = 'STR04' 
	              AND T2.MINOR_CD NOT IN('10', '90')
	              AND T1.AREA_FG = T2.MINOR_CD           
	     WHERE T0.VEN_CD  = #venCd#
	      <isNotEmpty property="ordDy" >
		    	AND T0.ORD_DY = #ordDy#
		  </isNotEmpty>  
		  <isEmpty property="ordDy" >
		  		AND T0.ORD_DY = TO_CHAR(CURRENT_TIMESTAMP(0)+1,'YYYYMMDD')
		  </isEmpty>
		  <isNotEmpty property="areaCd" >
		      	AND T1.AREA_FG = #areaCd#
		  </isNotEmpty>
		  <isNotEmpty property="strNm" >
		      	AND T1.STR_NM LIKE #strNm# ||'%'
		  </isNotEmpty>
		 GROUP BY T1.AREA_FG  ,T2.CD_NM, T1.STR_CD, T1.STR_NM, T1.SORT_ORDER  
	    ORDER BY T1.AREA_FG, T1.SORT_ORDER 
    </select>

	
</sqlMap>
