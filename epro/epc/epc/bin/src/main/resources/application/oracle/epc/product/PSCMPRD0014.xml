<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="PSCMPRD0014">
    <typeAlias alias="dataMap" type="com.lottemart.common.util.DataMap" />
    <typeAlias alias="pscmprd0014VO" type="com.lottemart.epc.product.model.PSCMPRD0014VO" />

    <select id="selectStoreCombo" resultClass="dataMap">
    SELECT STR_CD, STR_NM FROM TST_STORE WHERE ONLINE_YN = 'Y' ORDER BY STR_NM, STR_CD
    </select>

    <select id="selectOutOfStockCount" resultClass="dataMap">
    /* PSCMPRD0014.selectOutOfStockCount */
    SELECT COUNT(*) TOTAL_COUNT 
      FROM TPR_STORE_ITEM_PRICE A, TPR_PRODUCT P, V_CA_MD_CATEGORY D
     WHERE A.PROD_CD = P.PROD_CD
       AND P.CAT_CD = D.L3_CD
       AND A.SELL_PSBT_YN = 'Y'
       AND P.APRV_YN = 'Y'
       AND P.PROD_DIVN_CD in ('02','03')   -- 온라인 전용 상품과, 소셜상품중에서
       AND A.STR_CD = #strCd#
       <isNotEmpty property="vendorId">
       AND (0, P.VENDOR_ID) <iterate prepend="IN" property="vendorId" open="(" close=")" conjunction=","> (0, #vendorId[]#) </iterate>
       </isNotEmpty>
       <isEqual property="chkVal" compareValue="Y">
       AND (CASE WHEN #searchDateType# = '01' THEN P.REG_DATE
                 WHEN #searchDateType# = '02' THEN P.APRV_DATE
                 WHEN #searchDateType# = '03' THEN P.MD_REG_DATE
            END) BETWEEN TO_DATE(NVL(#startDate#,'1900-01-01')||'000000','YYYY-MM-DDHH24MISS')
                     AND TO_DATE(NVL(#endDate#,  '9999-12-31')||'235959','YYYY-MM-DDHH24MISS')
       </isEqual>
       <isNotEmpty prepend="AND" property="prodCd"> P.PROD_CD = #prodCd#</isNotEmpty>
       <isNotEmpty prepend="AND" property="prodNm"> P.PROD_NM LIKE '%'||#prodNm#||'%'</isNotEmpty>
       <isNotEmpty prepend="AND" property="dispYn"> A.DISP_YN = #dispYn#</isNotEmpty>
       <isNotEmpty prepend="AND" property="soutYn"> A.ONLINE_SOUT_YN = #soutYn#</isNotEmpty>
       <isNotEmpty prepend="AND" property="categoryId"> P.CATEGORY_ID = #categoryId#</isNotEmpty>
    </select>

    <select id="selectOutOfStockList" resultClass="dataMap">
    /* PSCMPRD0014.selectOutOfStockList */
    SELECT *
      FROM ( SELECT CEIL(NUM / #rowsPerPage#) AS PAGE
                  , COUNT(*) OVER() TOTAL_COUNT
                  , INNER_TABLE.*
               FROM ( SELECT ROWNUM AS NUM
                           , P.PROD_CD
                           , P.MD_PROD_CD
                           , P.PROD_NM
                           , P.NOCH_DELI_YN
                           , P.ENTP_PROD_COND_DELI_YN
                           , A.ITEM_CD
                           , A.STR_CD
                           , A.VENDOR_ID
                           , D.L1_NM
                           , D.L2_NM
                           , D.L3_NM
                           , D.L1_CD
                           , D.L2_CD
                           , D.L3_CD
                           , A.RSERV_STK_QTY
                           , A.ONLINE_SOUT_YN AS SOUT_YN
                           , A.DISP_YN
                           --전상법추가
                           , ( CASE WHEN (SELECT COUNT(A.INFO_GRP_CD) CNT
                                            FROM TPR_PROD_ADD_INFO_VAL A
                                               , V_PR_ADD_INFO B 
                                           WHERE 1=1
                                             AND A.INFO_GRP_CD = B.INFO_GRP_CD
                                             AND A.INFO_COL_CD = B.INFO_COL_CD
                                             AND A.PROD_CD = P.PROD_CD
                                             AND B.L3_CD = P.CAT_CD
                                        ) = 0 THEN 'N'
                                    WHEN (SELECT COUNT(A.INFO_GRP_CD) CNT
                                            FROM TPR_PROD_ADD_INFO_VAL A
                                               , V_PR_ADD_INFO B 
                                           WHERE 1=1
                                             AND A.INFO_GRP_CD = B.INFO_GRP_CD
                                             AND A.INFO_COL_CD = B.INFO_COL_CD
                                             AND A.PROD_CD = P.PROD_CD
                                             AND B.L3_CD = P.CAT_CD
                                         ) = (SELECT COUNT(A.INFO_GRP_CD) CNT
                                                FROM V_PR_ADD_INFO A
                                               WHERE 1=1
                                                 AND A.INFO_GRP_CD IN (SELECT INFO_GRP_CD FROM TPR_PROD_ADD_INFO_VAL WHERE PROD_CD = P.PROD_CD)
                                                 AND A.L3_CD = P.CAT_CD
                                             ) THEN 'Y' ELSE 'N'
                              END ) AS ECOM_YN
                            , CASE WHEN (SELECT 'Y' 
                                           FROM TPR_PROD_ADD_INFO_CNFM A 
                                          WHERE P.PROD_CD = A.PROD_CD
                                            LIMIT 1 
                                        ) = 'Y' THEN 'Y' ELSE 'N' 
                              END AS ECOM_YN_APPROVE
                            , DECODE(ONLINE_SOUT_YN,'Y','품절','판매진행') AS SELL_STATE
                            , DECODE(ONLINE_SOUT_YN,'Y','02','01') AS SELL_STATE_CD
                         FROM TPR_STORE_ITEM_PRICE A, TPR_PRODUCT P, V_CA_MD_CATEGORY D
                        WHERE A.PROD_CD = P.PROD_CD
                          AND P.CAT_CD = D.L3_CD
                          AND A.SELL_PSBT_YN = 'Y'
                          AND P.APRV_YN = 'Y'
                          AND P.PROD_DIVN_CD in ('02','03')   -- 온라인 전용 상품과, 소셜상품중에서
                          AND A.STR_CD = #strCd#
                          <isNotEmpty property="vendorId">
                          AND(0, P.VENDOR_ID) <iterate prepend="IN" property="vendorId" open="(" close=")" conjunction=","> (0,#vendorId[]#) </iterate>
                          </isNotEmpty>
                          <isNotEmpty property="prodInVal">
                          AND P.PROD_CD <iterate prepend="IN" property="prodInVal" open="(" close=")" conjunction=","> #prodInVal[]# </iterate>
                          </isNotEmpty>
                          <isEmpty property="prodInVal">
                          <isEqual property="chkVal" compareValue="Y">
                          AND ( CASE WHEN #searchDateType# = '01' THEN P.REG_DATE
                                     WHEN #searchDateType# = '02' THEN P.APRV_DATE
                                     WHEN #searchDateType# = '03' THEN P.MD_REG_DATE
                                END ) BETWEEN TO_DATE(NVL(#startDate#,'1900-01-01')||'000000','YYYY-MM-DDHH24MISS')
                                          AND TO_DATE(NVL(#endDate#,  '9999-12-31')||'235959','YYYY-MM-DDHH24MISS')
                          </isEqual>
                          <isNotEmpty prepend="AND" property="prodCd"> P.PROD_CD = #prodCd#</isNotEmpty>
                          <isNotEmpty prepend="AND" property="prodNm"> P.PROD_NM LIKE '%'||#prodNm#||'%'</isNotEmpty>
                          <isNotEmpty prepend="AND" property="dispYn"> A.DISP_YN = #dispYn#</isNotEmpty>
                          <isNotEmpty prepend="AND" property="soutYn"> A.ONLINE_SOUT_YN = #soutYn#</isNotEmpty>
                          <isNotEmpty prepend="AND" property="categoryId"> P.CATEGORY_ID = #categoryId#</isNotEmpty>
                          </isEmpty>
                    ) INNER_TABLE
    <![CDATA[
           )
       WHERE PAGE = #currentPage#
    ]]>
    </select>

    <update id="updateEntpProdCondDeli">
    /* PSCMPRD0014.updateEntpProdCondDeli */
    UPDATE TPR_PRODUCT
       SET NOCH_DELI_YN = #nochDeliYn#
         , ENTP_PROD_COND_DELI_YN = #entpProdCondDeliYn#
         , MOD_DATE = CURRENT_TIMESTAMP(0)
     WHERE PROD_CD = #prodCd#
    </update>

    <update id="updateOutOfStockProd">
    /* PSCMPRD0014.updateOutOfStockProd */
    UPDATE TPR_PRODUCT
       SET MOD_ID = #modId#
         , MOD_DATE = CURRENT_TIMESTAMP(0)
         <isNotNull property="prodNm"><isNotEmpty property="prodNm">, PROD_NM = #prodNm#</isNotEmpty></isNotNull>
     WHERE PROD_CD = #prodCd#
    </update>

    <update id="updateOutOfStockItem">
    /* PSCMPRD0014.updateOutOfStockItem */
    UPDATE TPR_STORE_ITEM_PRICE
       SET MOD_ID = #modId#
         , MOD_DATE = CURRENT_TIMESTAMP(0)
        <isEqual property="chgFlag" compareValue="02"><!-- 판매상태 -->
        <isEqual property="sellStateCd" compareValue="01"><!-- 판매진행 -->
         , ONLINE_SOUT_YN = 'N'
         , SELL_PSBT_YN = 'Y'
         , TEL_ORD_YN = 'Y'
        </isEqual>
        <isEqual property="sellStateCd" compareValue="02"><!-- 품절 -->
         , ONLINE_SOUT_YN = 'Y'
        </isEqual>
        <isEqual property="sellStateCd" compareValue="03"><!-- 판매종료 -->
         , ONLINE_SOUT_YN = 'Y'
         , DISP_YN = 'Y'
         , SELL_PSBT_YN = 'N'
         , TEL_ORD_YN = 'N'
        </isEqual>
        </isEqual>
        <isEqual property="chgFlag" compareValue="03"><!-- 전시상태 -->
         , DISP_YN = #dispYn#
        </isEqual>
        <isEqual property="chgFlag" compareValue="04"><!-- 재고수량 -->
         , RSERV_STK_QTY = #stkQty#
        </isEqual>
     WHERE PROD_CD = #prodCd#
       AND ITEM_CD = #itemCd#
       AND STR_CD = #strCd#
    </update>

    <update id="updateOutOfStockItemMst">
    /* PSCMPRD0014.updateOutOfStockItemMst */
    UPDATE TPR_PRODUCT 
       SET DISP_YN = #dispYn#
         , MOD_DATE = CURRENT_TIMESTAMP(0)
     WHERE PROD_CD = #prodCd#
    </update>

    <select id="selectOutOfStockListExcel" parameterClass="pscmprd0014VO" resultClass="dataMap">
    /* PSCMPRD0014.selectOutOfStockListExcel */
    SELECT P.PROD_CD
         , P.MD_PROD_CD
         , P.PROD_NM
         , A.ITEM_CD
         , A.STR_CD
         , A.VENDOR_ID
         , D.L1_NM
         , D.L2_NM
         , D.L3_NM
         , D.L1_CD
         , D.L2_CD
         , D.L3_CD
         , A.ONLINE_SOUT_YN AS SOUT_YN
         , A.DISP_YN
      FROM TPR_STORE_ITEM_PRICE A, TPR_PRODUCT P, V_CA_MD_CATEGORY D
     WHERE A.PROD_CD = P.PROD_CD
       AND P.CAT_CD = D.L3_CD
       AND A.SELL_PSBT_YN = 'Y'
       AND P.APRV_YN = 'Y'
       AND P.PROD_DIVN_CD in ('02','03')   -- 온라인 전용 상품과, 소셜상품중에서
       AND A.STR_CD = #strCd#
       <isNotEmpty property="vendorList">
       AND (0, P.VENDOR_ID) <iterate prepend="IN" property="vendorList" open="(" close=")" conjunction=","> (0,#vendorList[]#) </iterate>
       </isNotEmpty>
       <isEqual property="chkVal" compareValue="Y">
       AND ( CASE WHEN #searchDateType# = '01' THEN P.REG_DATE
                  WHEN #searchDateType# = '02' THEN P.APRV_DATE
                  WHEN #searchDateType# = '03' THEN P.MD_REG_DATE
             END
           ) BETWEEN TO_DATE(NVL(#startDate#,'1800-01-01')||'000000','YYYY-MM-DDHH24MISS')
                 AND TO_DATE(NVL(#endDate#,'9999-12-31')||'235959','YYYY-MM-DDHH24MISS')
        </isEqual>
        <isNotEmpty property="prodCd">AND P.PROD_CD = #prodCd#</isNotEmpty>
        <isNotEmpty property="prodNm">AND P.PROD_NM LIKE '%'||#prodNm#||'%'</isNotEmpty>
        <isNotEmpty property="dispYn">AND A.DISP_YN = #dispYn#</isNotEmpty>
        <isNotEmpty property="soutYn">AND A.ONLINE_SOUT_YN = #soutYn#</isNotEmpty>
        <isNotEmpty property="categoryId">AND P.CATEGORY_ID = #categoryId#</isNotEmpty>
    </select>

    <!-- 20180626 - 업체 공통조건 사용시 무료배송 'N' 처리(주문파트 요청건) 및 업체 배송비 관리 수정 (배송비 업체공통 조건 문구가 보여서 추가 처리) -->
    <select id="selectDeliVendorInfo" resultClass="dataMap">
    /* PSCMPRD0014.selectVendorDeliVendorInfo */
    SELECT DISTINCT VENDOR_ID
    FROM TVE_VENDOR_DELI_BASE
    WHERE TO_CHAR(CURRENT_TIMESTAMP(0),'YYYYMMDD') BETWEEN APPLY_START_DY AND APPLY_END_DY
    <isNotEmpty property="vendorList">
       AND (0, VENDOR_ID) <iterate prepend="IN" property="vendorList" open="(" close=")" conjunction=","> (0,#vendorList[]#) </iterate>
    </isNotEmpty>
    </select>

</sqlMap>