<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="PSCMORD0003">
	<typeAlias alias="dataMap" type="com.lottemart.common.util.DataMap" />
	<typeAlias alias="pscmord0003VO" type="com.lottemart.epc.order.model.PSCMORD0003VO"/>


	<select id="selectAllOnlineStore" resultClass="dataMap">
		  SELECT /* PSCMORD0003.selectAllOnlineStore */
		         STR_CD
		         ,STR_NM
		    FROM TST_STORE 
		   WHERE (ONLINE_YN = 'Y' OR ONLINE_REP_STR_YN = 'Y')
		ORDER BY STR_NM	
	</select>
			
			
	<select id="selectHodevMallStrYn" resultClass="dataMap" parameterClass="pscmord0003VO">
		  SELECT /* PSCMORD0003.selectHodevMallStrYn */ 
		         HODEV_MALL_STR_YN
		    FROM TST_STORE
		   WHERE STR_CD = #strCd#	
	</select>			
			
			
	<select id="selectCodeList" resultClass="dataMap" parameterClass="pscmord0003VO">
		/* PSCMORD0003.selectCodeList */
		SELECT MINOR_CD, CD_NM FROM TET_CODE WHERE MAJOR_CD = #majorCd#	
	</select>			
			
			
	<select id="selectOrderList" resultClass="dataMap" parameterClass="dataMap">
		/* PSCMORD0003.selectOrderList */ 
			SELECT * FROM(
			    SELECT CEIL(ROWNUM / #rowsPerPage#  ) PAGE
			        , ROWNUM AS NUM
			        , COUNT(*) OVER() TOTAL_COUNT
			        , E.* 
		            , <![CDATA[
      	  			    CASE WHEN SUBSTR(DM.DELI_FNSH_DATE, 0, 8) < TO_CHAR(ADD_MONTHS(CURRENT_TIMESTAMP(0), -1),'YYYYMMDD') AND DELI_NO IS NOT NULL AND E.DELI_STATUS_CD ='51'
                            THEN SUBSTR(E.ORG_CUST_NM,1,1) || LPAD('*',LENGTH(E.ORG_CUST_NM)-2,'*') || SUBSTR(E.ORG_CUST_NM,LENGTH(E.ORG_CUST_NM),1) 
                            WHEN SUBSTR(TO_CHAR(TO_DATE(E.ORD_DY, 'YYYY-MM-DD'),'YYYYMMDD'), 0, 8) < TO_CHAR(ADD_MONTHS(CURRENT_TIMESTAMP(0), -1),'YYYYMMDD') AND DM.DELI_NO IS NULL AND SALE_STS_CD IN('11','12','13')
                            THEN SUBSTR(E.ORG_CUST_NM,1,1) || LPAD('*',LENGTH(E.ORG_CUST_NM)-2,'*') || SUBSTR(E.ORG_CUST_NM,LENGTH(E.ORG_CUST_NM),1) 
                            ELSE E.ORG_CUST_NM END AS CUST_NM 
                        ]]>
			      FROM (
			        SELECT /*+LEADING(O I DE) INDEX_SS(O IX_OR_ORDER_14)*/
			              O.ORDER_ID
			            , O.UP_ORDER_ID
			            , (SELECT STR_NM FROM   TST_STORE WHERE  STR_CD = O.STR_CD) STR_NM 
			            , O.ORD_STS_CD
			            , (SELECT CD_NM FROM TET_CODE WHERE MAJOR_CD = 'OR002' AND MINOR_CD = O.ORD_STS_CD) AS ORD_STS_NM
			            , O.SALE_STS_CD
			            , (SELECT CD_NM FROM TET_CODE WHERE MAJOR_CD = 'OR003' AND MINOR_CD = O.SALE_STS_CD) AS SALE_STS_NM						
			            , SUM (DECODE (I.ORD_ITEM_DIVN_CD,
			                                   '11', 0,
			                                   '12', 0,
			                                   '13', 0,
			                                   I.ORD_AMT
			                                 )
			                         ) AS ORDER_ITEM_AMT_SUM
			             ,SUM (  NVL (I.DC_AMT, 0)
			                           + NVL (I.CMS_COUPON_DC_AMT, 0)
			                           + NVL (I.COUPON_DC_AMT, 0)
			                           + NVL (I.STAFF_DC_AMT, 0)
			                  ) AS DC_AMT_SUM
			             ,SUM (DECODE (I.ORD_ITEM_DIVN_CD,
			                                   '11', I.ORD_AMT,
			                                   '12', I.ORD_AMT,
			                                   '13', I.ORD_AMT,
			                                   0
			                           )
			                  ) AS DELIVERY_AMT_SUM
			            , ( SELECT NVL(SUM(NVL(DPST_AMT, 0)+NVL(SIN_DC, 0)), 0) FROM TOR_DEMAND WHERE ORDER_ID = O.ORDER_ID AND SETL_TYPE_CD IN (SELECT MINOR_CD FROM TET_CODE WHERE MAJOR_CD = 'OR008' and LET_1_REF = '0') ) AS APPLY_TOT_AMT
			            , ( SELECT max(CD_NM) FROM TET_CODE C, TOR_DEMAND D WHERE D.ORDER_ID = O.ORDER_ID AND C.MAJOR_CD='OR008' AND D.SETL_TYPE_CD = C.MINOR_CD ) AS SETL_TYPE_NM
			            , ( SELECT NVL(SUM(NVL(DPST_AMT, 0)+NVL(SIN_DC, 0)), 0) FROM TOR_DEMAND WHERE ORDER_ID = O.ORDER_ID AND SETL_TYPE_CD = '04' ) AS APPLY_OCUR_POINT
			            , ( SELECT NVL(SUM(NVL(DPST_AMT, 0)+NVL(SIN_DC, 0)), 0) FROM TOR_DEMAND WHERE ORDER_ID = O.ORDER_ID AND SETL_TYPE_CD = '03' ) AS APPLY_COUPON_AMT
			            , TO_CHAR(TO_DATE(O.ORD_DY, 'YYYY-MM-DD'),'YYYY-MM-DD') AS ORD_DY  
			            , SUM(I.BUY_PRC*(I.ORD_QTY+I.EXTRA_QTY)) AS BUY_PRC
			            , MAX(I.DELI_STATUS_CD) AS DELI_STATUS_CD
                        , MAX(I.DELIVERY_ID) AS DELIVERY_ID 
                        , (SELECT CUST_NM FROM TDE_ORDER_DELIVERY WHERE ORDER_ID = O.ORDER_ID AND DELIVERY_ID='000') AS ORG_CUST_NM                                                                      
			          FROM TOR_ORDER O, TDE_ORDER_DELIVERY DE, TOR_ORDER_ITEM I
			          	 , TSA_TLOGSELECT MD			         
			         WHERE O.ORDER_ID = DE.ORDER_ID
			           AND O.ORDER_ID = I.ORDER_ID			           
			           AND DE.DELIVERY_ID = I.DELIVERY_ID
			           AND MD.ORDER_ID = O.ORDER_ID
			           AND O.STR_CD = MD.RETAILSTOREID
			           AND MD.RECORDQUALIFIER = '5'
                       AND MD.ORDER_ITEM_SEQ = I.ORDER_ITEM_SEQ
                       AND MD.WORKSTATIONID IN (SELECT POS_NO FROM TET_TLOG_POS WHERE SALE_TYPE IN ('1', '2') AND USE_YN = 'Y')
			           AND O.BSKET_TYPE_CD IN ('24','25')
		               AND EXISTS (SELECT 'X' FROM TLOGSEND SS 
                                      WHERE MD.RETAILSTOREID   = SS.RETAILSTOREID
                                  		AND MD.BUSINESSDAYDATE = SS.BUSINESSDAYDATE
                                  		AND MD.WORKSTATIONID   = SS.WORKSTATIONID
                                  		AND MD.TRANSNUMBER     = SS.TRANSNUMBER
                                 		AND MD.TRANSTYPECODE   = SS.TRANSTYPECODE	/* tr전송시 lpoint에러로 인해 재전송을 할 경우 중복 에러를 해결하기위해 key추가 */
                                  		AND SS.TRANSTYPECODE NOT IN ('0050','0060')	/* 20160624 김학수 추가 [현금연수증,LPOINT는 매출에서제외(중복제거)] */
                                  		AND SS.RESULT_STATUS = 'C')
                       AND NOT EXISTS (SELECT 'X' FROM TLOGERR LE 
                                          WHERE MD.RETAILSTOREID   = LE.RETAILSTOREID
                                            AND MD.BUSINESSDAYDATE = LE.BUSINESSDAYDATE
                                            AND MD.WORKSTATIONID   = LE.WORKSTATIONID
                                            AND MD.TRANSNUMBER     = LE.TRANSNUMBER
                      			        AND MD.TRANSTYPECODE   = LE.TRANSTYPECODE	/* tr전송시 lpoint에러로 인해 재전송을 할 경우 중복 에러를 해결하기위해 key추가 */
									  )  
<!-- 			           AND DE.DELIVERY_ID = '000' -->
		           AND O.ORD_DY BETWEEN REPLACE(#startDate#, '-', '') AND REPLACE(#endDate#, '-', '')
			<isNotEmpty property="vendorId">
		           AND (0, I.STR_VENDOR_ID) 
		    	<iterate prepend="IN" property="vendorId" open="(" close=")" conjunction=",">
		    	         (0, #vendorId[]#)
		    	</iterate>
		    </isNotEmpty>     
			<isNotEmpty property="orderId">
		           AND O.UP_ORDER_ID = #orderId#
		    </isNotEmpty>     
			<isNotEmpty property="strCd">
		           AND O.STR_CD = #strCd#
		    </isNotEmpty>     
		    <isNotEmpty property="ordStsCd">
		           AND O.ORD_STS_CD = #ordStsCd#
		    </isNotEmpty>
		    <isNotEmpty property="saleStsCd">
		           AND O.SALE_STS_CD = #saleStsCd#
		    </isNotEmpty>
		    <isNotEmpty property="setlTypeCd">
		           AND EXISTS ( SELECT 1 FROM TOR_DEMAND WHERE ORDER_ID = O.ORDER_ID AND SETL_TYPE_CD = #setlTypeCd# LIMIT 1 )
		    </isNotEmpty>			    
		    <isNotEmpty property="custNm">
		           AND DE.CUST_NM Like #custNm#||'%'
		    </isNotEmpty>			    
		      GROUP BY O.ORDER_ID, O.UP_ORDER_ID,O.STR_CD,  O.ORD_STS_CD, O.SALE_STS_CD, DE.CUST_NM, O.ORD_DY
		    )   E, TDE_DELI_MST DM
               WHERE E.ORDER_ID = DM.ORDER_ID(+)
                 AND E.DELIVERY_ID = DM.DELIVERY_ID(+)
		)
		WHERE PAGE = #currentPage#
	 ORDER BY UP_ORDER_ID, ORDER_ID					
	</select>				
		
		
	<select id="selectOrderListExcel" resultClass="dataMap" parameterClass="dataMap">
		/* PSCMORD0003.selectOrderListExcel */ 
	        SELECT O.ORDER_ID
	            , O.UP_ORDER_ID
	            , O.ORD_STS_CD
	            , (SELECT CD_NM FROM TET_CODE WHERE MAJOR_CD = 'OR002' AND MINOR_CD = O.ORD_STS_CD) AS ORD_STS_NM
	            , O.SALE_STS_CD
	            , (SELECT CD_NM FROM TET_CODE WHERE MAJOR_CD = 'OR003' AND MINOR_CD = O.SALE_STS_CD) AS SALE_STS_NM
	            <![CDATA[
	            , CASE WHEN ORD_DY < TO_CHAR(ADD_MONTHS(CURRENT_TIMESTAMP(0), -1),'YYYYMMDD') THEN '***' ELSE  DE.CUST_NM END AS CUST_NM
	            ]]>
	            , SUM (DECODE (I.ORD_ITEM_DIVN_CD,
	                                   '11', 0,
	                                   '12', 0,
	                                   '13', 0,
	                                   I.ORD_AMT
	                                 )
	                         ) AS ORDER_ITEM_AMT_SUM
	            , SUM (  NVL (I.DC_AMT, 0)
	                           + NVL (I.CMS_COUPON_DC_AMT, 0)
	                           + NVL (I.COUPON_DC_AMT, 0)
	                           + NVL (I.STAFF_DC_AMT, 0)
	                  ) AS DC_AMT_SUM
	            , SUM (DECODE (I.ORD_ITEM_DIVN_CD,
	                                   '11', I.ORD_AMT,
	                                   '12', I.ORD_AMT,
	                                   '13', I.ORD_AMT,
	                                   0
	                           )
	                  ) AS DELIVERY_AMT_SUM
	            , ( SELECT NVL(SUM(NVL(DPST_AMT, 0)+NVL(SIN_DC, 0)), 0) FROM TOR_DEMAND WHERE ORDER_ID = O.ORDER_ID AND SETL_TYPE_CD IN (SELECT MINOR_CD FROM TET_CODE WHERE MAJOR_CD = 'OR008' and LET_1_REF = '0') ) AS APPLY_TOT_AMT
	            , ( SELECT max(CD_NM) FROM TET_CODE C, TOR_DEMAND D WHERE D.ORDER_ID = O.ORDER_ID AND C.MAJOR_CD='OR008' AND D.SETL_TYPE_CD = C.MINOR_CD ) AS SETL_TYPE_NM
	            , ( SELECT NVL(SUM(NVL(DPST_AMT, 0)+NVL(SIN_DC, 0)), 0) FROM TOR_DEMAND WHERE ORDER_ID = O.ORDER_ID AND SETL_TYPE_CD = '04' ) AS APPLY_OCUR_POINT
	            , ( SELECT NVL(SUM(NVL(DPST_AMT, 0)+NVL(SIN_DC, 0)), 0) FROM TOR_DEMAND WHERE ORDER_ID = O.ORDER_ID AND SETL_TYPE_CD = '03' ) AS APPLY_COUPON_AMT
	            , TO_CHAR(TO_DATE(O.ORD_DY, 'YYYY-MM-DD'),'YYYY-MM-DD') AS ORD_DY        
	            , SUM(I.BUY_PRC*(I.ORD_QTY+I.EXTRA_QTY)) AS BUY_PRC                                     
			          FROM TOR_ORDER O, TDE_ORDER_DELIVERY DE, TOR_ORDER_ITEM I
			          	 , TSA_TLOGSELECT MD
			         WHERE O.ORDER_ID = DE.ORDER_ID
			           AND O.ORDER_ID = I.ORDER_ID
			           AND DE.DELIVERY_ID = I.DELIVERY_ID
			           AND MD.ORDER_ID = O.ORDER_ID
			           AND O.STR_CD = MD.RETAILSTOREID
			           AND MD.RECORDQUALIFIER = '5'
                       AND MD.ORDER_ITEM_SEQ = I.ORDER_ITEM_SEQ
                       AND MD.WORKSTATIONID IN (SELECT POS_NO FROM TET_TLOG_POS WHERE SALE_TYPE IN ('1', '2') AND USE_YN = 'Y')
			           AND O.BSKET_TYPE_CD IN ('24','25')
		               AND EXISTS (SELECT 'X' FROM TLOGSEND SS 
                                      WHERE MD.RETAILSTOREID   = SS.RETAILSTOREID
                                  		AND MD.BUSINESSDAYDATE = SS.BUSINESSDAYDATE
                                  		AND MD.WORKSTATIONID   = SS.WORKSTATIONID
                                  		AND MD.TRANSNUMBER     = SS.TRANSNUMBER
                                 		AND MD.TRANSTYPECODE   = SS.TRANSTYPECODE	/* tr전송시 lpoint에러로 인해 재전송을 할 경우 중복 에러를 해결하기위해 key추가 */
                                  		AND SS.TRANSTYPECODE NOT IN ('0050','0060')	/* 20160624 김학수 추가 [현금연수증,LPOINT는 매출에서제외(중복제거)] */
                                  		AND SS.RESULT_STATUS = 'C')
                       AND NOT EXISTS (SELECT 'X' FROM TLOGERR LE 
                                          WHERE MD.RETAILSTOREID   = LE.RETAILSTOREID
                                            AND MD.BUSINESSDAYDATE = LE.BUSINESSDAYDATE
                                            AND MD.WORKSTATIONID   = LE.WORKSTATIONID
                                            AND MD.TRANSNUMBER     = LE.TRANSNUMBER
                                          AND MD.TRANSTYPECODE   = LE.TRANSTYPECODE	/* tr전송시 lpoint에러로 인해 재전송을 할 경우 중복 에러를 해결하기위해 key추가 */
									  )  
   					   AND O.ORD_DY BETWEEN REPLACE(#startDate#, '-', '') AND REPLACE(#endDate#, '-', '')                                            
		<isNotEmpty property="vendorId">
	           AND(0,  I.STR_VENDOR_ID )
	    	<iterate prepend="IN" property="vendorId" open="(" close=")" conjunction=",">
	    	          (0, #vendorId[]#)
	    	</iterate>
	    </isNotEmpty>     
		<isNotEmpty property="orderId">
	           AND O.UP_ORDER_ID = #orderId#
	    </isNotEmpty>     
		<isNotEmpty property="strCd">
	           AND O.STR_CD = #strCd#
	    </isNotEmpty>     
	    <isNotEmpty property="ordStsCd">
	           AND O.ORD_STS_CD = #ordStsCd#
	    </isNotEmpty>
	    <isNotEmpty property="saleStsCd">
	           AND O.SALE_STS_CD = #saleStsCd#
	    </isNotEmpty>
	    <isNotEmpty property="setlTypeCd">
	           AND EXISTS ( SELECT 1 FROM TOR_DEMAND WHERE ORDER_ID = O.ORDER_ID AND SETL_TYPE_CD = #setlTypeCd# LIMIT 1 )
	    </isNotEmpty>			    
	    <isNotEmpty property="custNm">
	           AND DE.CUST_NM Like #custNm#||'%'
	    </isNotEmpty>			    
	      GROUP BY O.ORDER_ID, O.UP_ORDER_ID, O.ORD_STS_CD, O.SALE_STS_CD, DE.CUST_NM, O.ORD_DY
		  ORDER BY UP_ORDER_ID, ORDER_ID	
	</select>			
	
	<select id="selectCustInfo" resultClass="java.lang.String">
	/* PSCMORD0003.selectCustInfo */
		    SELECT NVL(SUM(CUST_NM), 0) AS STATUS
			FROM (SELECT  
         	<![CDATA[ CASE WHEN SUBSTR(DM.DELI_FNSH_DATE, 0, 8) < TO_CHAR(ADD_MONTHS(CURRENT_TIMESTAMP(0), -6),'YYYYMMDD') AND DELI_NO IS NOT NULL AND AA.DELI_STATUS_CD ='51'
                               THEN '1' 
                               WHEN SUBSTR(TO_CHAR(TO_DATE(AA.ORD_DY, 'YYYY-MM-DD'),'YYYYMMDD'), 0, 8) < TO_CHAR(ADD_MONTHS(CURRENT_TIMESTAMP(0), -6),'YYYYMMDD') AND DELI_NO IS NULL  AND SALE_STS_CD IN('11','12','13')
                               THEN '1'
                               ELSE '0' END AS CUST_NM    
              ]]>    
			 FROM ( SELECT  O.ORDER_ID
						, MAX(I.DELIVERY_ID) AS DELIVERY_ID
						, MAX(I.DELI_STATUS_CD) AS DELI_STATUS_CD
						, O.SALE_STS_CD 
						, O.ORD_DY
						, (SELECT CUST_NM FROM TDE_ORDER_DELIVERY WHERE ORDER_ID = O.ORDER_ID AND DELIVERY_ID='000') AS ORG_CUST_NM
			      FROM TOR_ORDER O, TDE_ORDER_DELIVERY DE, TOR_ORDER_ITEM I
			          	 , TSA_TLOGSELECT MD
			         WHERE 1=1			           
			           AND O.ORDER_ID = I.ORDER_ID
			           AND DE.DELIVERY_ID = I.DELIVERY_ID
			           AND MD.ORDER_ID = O.ORDER_ID
			           AND O.STR_CD = MD.RETAILSTOREID
			           AND MD.RECORDQUALIFIER = '5'
                       AND MD.ORDER_ITEM_SEQ = I.ORDER_ITEM_SEQ
                       AND MD.WORKSTATIONID IN (SELECT POS_NO FROM TET_TLOG_POS WHERE SALE_TYPE IN ('1', '2') AND USE_YN = 'Y')
			           AND O.BSKET_TYPE_CD IN ('24','25')
		               AND EXISTS (SELECT 'X' FROM TLOGSEND SS 
                                      WHERE MD.RETAILSTOREID   = SS.RETAILSTOREID
                                  		AND MD.BUSINESSDAYDATE = SS.BUSINESSDAYDATE
                                  		AND MD.WORKSTATIONID   = SS.WORKSTATIONID
                                  		AND MD.TRANSNUMBER     = SS.TRANSNUMBER
                                 		AND MD.TRANSTYPECODE   = SS.TRANSTYPECODE	/* tr전송시 lpoint에러로 인해 재전송을 할 경우 중복 에러를 해결하기위해 key추가 */
                                  		AND SS.TRANSTYPECODE NOT IN ('0050','0060')	/* 20160624 김학수 추가 [현금연수증,LPOINT는 매출에서제외(중복제거)] */
                                  		AND SS.RESULT_STATUS = 'C')
                       AND NOT EXISTS (SELECT 'X' FROM TLOGERR LE 
                                          WHERE MD.RETAILSTOREID   = LE.RETAILSTOREID
                                            AND MD.BUSINESSDAYDATE = LE.BUSINESSDAYDATE
                                            AND MD.WORKSTATIONID   = LE.WORKSTATIONID
                                            AND MD.TRANSNUMBER     = LE.TRANSNUMBER
                                          AND MD.TRANSTYPECODE   = LE.TRANSTYPECODE	/* tr전송시 lpoint에러로 인해 재전송을 할 경우 중복 에러를 해결하기위해 key추가 */
									  )  
                                            
<!-- 			           AND DE.DELIVERY_ID = '000' -->
		           AND O.ORD_DY BETWEEN REPLACE(#startDate#, '-', '') AND REPLACE(#endDate#, '-', '')
			<isNotEmpty property="vendorId">
		           AND(0,  I.STR_VENDOR_ID )
		    	<iterate prepend="IN" property="vendorId" open="(" close=")" conjunction=",">
		    	          (0, #vendorId[]#)
		    	</iterate>
		    </isNotEmpty>     
			<isNotEmpty property="orderId">
		           AND O.UP_ORDER_ID = #orderId#
		    </isNotEmpty>     
			<isNotEmpty property="strCd">
		           AND O.STR_CD = #strCd#
		    </isNotEmpty>     
		    <isNotEmpty property="ordStsCd">
		           AND O.ORD_STS_CD = #ordStsCd#
		    </isNotEmpty>
		    <isNotEmpty property="saleStsCd">
		           AND O.SALE_STS_CD = #saleStsCd#
		    </isNotEmpty>
		    <isNotEmpty property="setlTypeCd">
		           AND EXISTS ( SELECT 1 FROM TOR_DEMAND WHERE ORDER_ID = O.ORDER_ID AND SETL_TYPE_CD = #setlTypeCd# LIMIT 1 )
		    </isNotEmpty>			    
		    <isNotEmpty property="custNm">
		           AND DE.CUST_NM Like #custNm#||'%'
		    </isNotEmpty>		
		       GROUP BY O.ORDER_ID,  O.SALE_STS_CD, DE.CUST_NM, O.ORD_DY  
		         ) AA, TDE_DELI_MST DM
	 		WHERE AA.ORDER_ID = DM.ORDER_ID (+)
	   		AND AA.DELIVERY_ID = DM.DELIVERY_ID (+)
   		)  
	</select>	
</sqlMap>