<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="PEDMUSP0000">

<typeAlias alias="resultClass"	type="lcn.module.common.util.HashBox" />
<typeAlias alias="paramClass"	type="lcn.module.common.util.HashBox" />

<!-- 일자별 -->
<select id="TSC_DAY-SELECT01" parameterClass="map" resultClass="resultClass">
	/* PEDMUSP0000.TSC_DAY-SELECT01 */
	SELECT	TO_CHAR(TO_DATE(SPLY_DY,'yyyymmdd'),'YYYY-MM-DD') SPLY_DY
		   ,SUM(NVL(ORD_QTY,0)/NVL(ORD_IPSU,0))  AS ORD_QTY
	       ,SUM(ORD_BUY_AMT) AS ORD_BUY_AMT
	       
	       ,SUM(NVL(BUY_QTY,0)/NVL(ORD_IPSU,0))  AS BUY_QTY
	       ,SUM(BUY_BUY_AMT) AS BUY_BUY_AMT
	       
	       ,SUM(NVL(USPLY_QTY,0)/NVL(ORD_IPSU,0))  AS USPLY_QTY
	       ,SUM(USPLY_BUY_AMT) AS USPLY_BUY_AMT
	       ,TO_CHAR( ROUND (SUM(USPLY_BUY_AMT) / ( DECODE(SUM(ORD_BUY_AMT),0,1,SUM(ORD_BUY_AMT)) ) * 100 , 1) )AS USPLY_RATIO
	
	FROM  TED_USPLY_PROD
	
	WHERE SPLY_DY BETWEEN replace(#startDate#,'-','') and replace(#endDate#,'-','')
	      <isNotEmpty  property="venCds"  prepend="AND"> 
		      <iterate prepend="VEN_CD IN " property="venCds" open="(" close=")" conjunction=","> 
		        #venCds[]# 
		      </iterate> 
		    </isNotEmpty>
		   
		   <isNotEmpty  property="entp_cd"  prepend="AND"> 
		    	VEN_CD = #entp_cd#
		   </isNotEmpty>
		    

           <isNotEmpty property="storeVal"  prepend="AND"> 
		     <iterate prepend="STR_CD IN " property="storeVal" open="(" close=")" conjunction=","> 
		       #storeVal[]# 
		     </iterate> 
		   </isNotEmpty>
		    
		   <isNotEmpty  property="productVal"  prepend="AND"> 
		    	PROD_CD = #productVal#
		   </isNotEmpty>
	
	  GROUP BY SPLY_DY
	  ORDER BY SPLY_DY || ''
	  
</select>

<!-- 점포별 -->
<select id="TSC_STORE-SELECT01" parameterClass="map" resultClass="resultClass">
	/* PEDMUSP0000.TSC_STORE-SELECT01 */
	SELECT	TO_CHAR(TO_DATE(A.SPLY_DY,'yyyymmdd'),'YYYY-MM-DD') SPLY_DY
	       ,B.STR_NM
	       ,SUM(NVL(A.ORD_QTY,0)/NVL(A.ORD_IPSU,0))  AS ORD_QTY
	       ,SUM(A.ORD_BUY_AMT) AS ORD_BUY_AMT
	       
	       ,SUM(NVL(A.BUY_QTY,0)/NVL(A.ORD_IPSU,0))  AS BUY_QTY
	       ,SUM(A.BUY_BUY_AMT) AS BUY_BUY_AMT
	       
	       ,SUM(NVL(A.USPLY_QTY,0)/NVL(A.ORD_IPSU,0))  AS USPLY_QTY
	       ,SUM(A.USPLY_BUY_AMT) AS USPLY_BUY_AMT
	       ,A.STR_CD
	
	FROM  TED_USPLY_PROD A INNER JOIN STORE@dl_md_martnis B ON A.STR_CD = B.STR_CD
	
	WHERE SPLY_DY BETWEEN replace(#startDate#,'-','') and replace(#endDate#,'-','')
	      <isNotEmpty  property="venCds"  prepend="AND"> 
		      <iterate prepend="A.VEN_CD IN " property="venCds" open="(" close=")" conjunction=","> 
		        #venCds[]# 
		      </iterate> 
		    </isNotEmpty>
		   
		   <isNotEmpty  property="entp_cd"  prepend="AND"> 
		    	A.VEN_CD = #entp_cd#
		   </isNotEmpty>
		    

           <isNotEmpty property="storeVal"  prepend="AND"> 
		     <iterate prepend="A.STR_CD IN " property="storeVal" open="(" close=")" conjunction=","> 
		       #storeVal[]# 
		     </iterate> 
		   </isNotEmpty>
		    
		   <isNotEmpty  property="productVal"  prepend="AND"> 
		    	A.PROD_CD = #productVal#
		   </isNotEmpty>
	
	  GROUP BY A.SPLY_DY, B.STR_NM, A.STR_CD
 	  ORDER BY A.SPLY_DY, A.STR_CD
</select>

<!-- 상품별 -->
<select id="TSC_PRODUCT-SELECT01" parameterClass="map" resultClass="resultClass">
/* PEDMUSP0000.TSC_PRODUCT-SELECT01 */
	SELECT	TO_CHAR(TO_DATE(A.SPLY_DY,'yyyymmdd'),'YYYY-MM-DD') SPLY_DY
	       ,A.SRCMK_CD
	       ,MAX(A.PROD_NM) AS PROD_NM
	       ,A.ORD_IPSU
	       ,C1.CD_NM AS ORD_UNIT
	       ,SUM(NVL(A.ORD_QTY,0)/NVL(A.ORD_IPSU,0))  AS ORD_QTY
	       ,SUM(A.ORD_BUY_AMT) AS ORD_BUY_AMT
	       ,SUM(NVL(A.BUY_QTY,0)/NVL(A.ORD_IPSU,0))  AS BUY_QTY
	       ,SUM(A.BUY_BUY_AMT) AS BUY_BUY_AMT
	       ,SUM(NVL(A.USPLY_QTY,0)/NVL(A.ORD_IPSU,0))  AS USPLY_QTY
	       ,SUM(A.USPLY_BUY_AMT) AS USPLY_BUY_AMT
	
	FROM   TED_USPLY_PROD A LEFT OUTER JOIN TET_CODE C1 ON C1.MAJOR_CD='CSA01'
													  AND C1.MINOR_CD = A.ORD_UNIT
	
	WHERE SPLY_DY BETWEEN replace(#startDate#,'-','') and replace(#endDate#,'-','')
	      <isNotEmpty  property="venCds"  prepend="AND"> 
		      <iterate prepend="A.VEN_CD IN " property="venCds" open="(" close=")" conjunction=","> 
		        #venCds[]# 
		      </iterate> 
		    </isNotEmpty>
		   
		   <isNotEmpty  property="entp_cd"  prepend="AND"> 
		    	A.VEN_CD = #entp_cd#
		   </isNotEmpty>
		    

           <isNotEmpty property="storeVal"  prepend="AND"> 
		     <iterate prepend="A.STR_CD IN " property="storeVal" open="(" close=")" conjunction=","> 
		       #storeVal[]# 
		     </iterate> 
		   </isNotEmpty>
		    
		   <isNotEmpty  property="productVal"  prepend="AND"> 
		    	A.PROD_CD = #productVal#
		   </isNotEmpty>
	
	  GROUP BY A.SPLY_DY, A.SRCMK_CD, A.ORD_IPSU, C1.CD_NM
  	  ORDER BY A.SPLY_DY, A.SRCMK_CD
</select>

<!-- 상품상세 -->
<select id="TSC_PRODUCT_DETAIL-SELECT01" parameterClass="map" resultClass="resultClass">
/* PEDMUSP0000.TSC_PRODUCT_DETAIL-SELECT01 */
	SELECT	A.SRCMK_CD
	       ,MAX(A.PROD_NM) AS PROD_NM
	       ,A.ORD_IPSU
	       ,C1.CD_NM AS ORD_UNIT
	       ,B.STR_NM
	       ,B.STR_CD
	       ,SUM(NVL(A.ORD_QTY,0)/NVL(A.ORD_IPSU,0))  AS ORD_QTY
	       ,SUM(A.ORD_BUY_AMT) AS ORD_BUY_AMT
	       ,SUM(NVL(A.BUY_QTY,0)/NVL(A.ORD_IPSU,0))  AS BUY_QTY
	       ,SUM(A.BUY_BUY_AMT) AS BUY_BUY_AMT
	       ,SUM(NVL(A.USPLY_QTY,0)/NVL(A.ORD_IPSU,0))  AS USPLY_QTY
	       ,SUM(A.USPLY_BUY_AMT) AS USPLY_BUY_AMT
	
	FROM  TED_USPLY_PROD A LEFT OUTER JOIN TET_CODE C1 ON C1.MAJOR_CD='CSA01'
													 AND C1.MINOR_CD = A.ORD_UNIT
	                       INNER JOIN STORE@dl_md_martnis B ON A.STR_CD=B.STR_CD
	
	WHERE SPLY_DY BETWEEN replace(#startDate#,'-','') and replace(#endDate#,'-','')
	       <isNotEmpty  property="venCds"  prepend="AND"> 
		      <iterate prepend="A.VEN_CD IN " property="venCds" open="(" close=")" conjunction=","> 
		        #venCds[]# 
		      </iterate> 
		    </isNotEmpty>
		   
		   <isNotEmpty  property="entp_cd"  prepend="AND"> 
		    	A.VEN_CD = #entp_cd#
		   </isNotEmpty>
		    

           <isNotEmpty property="storeVal"  prepend="AND"> 
		     <iterate prepend="A.STR_CD IN " property="storeVal" open="(" close=")" conjunction=","> 
		       #storeVal[]# 
		     </iterate> 
		   </isNotEmpty>
		    
		   <isNotEmpty  property="productVal"  prepend="AND"> 
		    	A.PROD_CD = #productVal#
		   </isNotEmpty>
		   
		   <isNotEmpty  property="srcmkVal"  prepend="AND"> 
		    	A.SRCMK_CD = #srcmkVal#
		   </isNotEmpty>
	
	  GROUP BY A.SRCMK_CD, A.PROD_STD, A.ORD_IPSU, B.STR_NM, A.STR_CD, C1.CD_NM, B.STR_CD
	  ORDER BY A.SRCMK_CD, A.STR_CD
</select>

<!-- 미납사유조회 -->
<select id="TSC_USPLY_REASON-SELECT01" parameterClass="map" resultClass="resultClass">
<![CDATA[
/* PEDMUSP0000.TSC_USPLY_REASON-SELECT01 */
	SELECT  B.SRCMK_CD, D.PROD_NM, B.PROD_STD, B.ORD_IPSU, (SELECT detail_nm FROM ALL_CD@dl_md_martnis WHERE	all_cd.grp_cd='CSA01' and all_cd.detail_cd = b.ord_unit) as ORD_UNIT, F.STR_NM, B.USPLY_QTY, B.USPLY_BUY_AMT,
		    DECODE(B.VEN_REASON_FG, '1', '협력업체', '2', '롯데마트', '미등록') AS VEN_REASON_NM,
		    NVL((SELECT DETAIL_NM FROM ALL_CD@DL_MD_MARTNIS WHERE GRP_CD='USL04' AND DETAIL_CD=B.VEN_DETAIL_FG), '미등록') AS VEN_DETAIL_NM ,
		    NVL(B.REG_REASON_FG, '') REG_REASON_FG,
		    NVL(B.CFM_REASON_FG, '') CFM_REASON_FG,
		    NVL(B.REG_DETAIL_FG, '') REG_DETAIL_FG,
		    NVL(B.CFM_DETAIL_FG, '') CFM_DETAIL_FG,
		    
		    B.PROD_CD, B.ORD_SLIP_NO,
		    
		    B.VEN_REASON_FG, B.VEN_DETAIL_FG, B.VEN_CFM_FG
	
	FROM	UNSUPPLY@dl_md_martnis    A,
			USPLY_PROD@dl_md_martnis  B,
	        ALL_CD@dl_md_martnis      C,
	        PRODUCT@dl_md_martnis     D,
	        VENDOR@dl_md_martnis      E,
	        STORE@dl_md_martnis       F
	
	WHERE   A.ORD_SLIP_NO       = B.ORD_SLIP_NO
	    AND B.ORD_UNIT          = C.DETAIL_CD
	    AND A.STR_CD            = E.STR_CD
	    AND A.VEN_CD            = E.VEN_CD
	    AND A.STR_CD            = F.STR_CD
	    AND A.TRD_TYP_FG        = '1'   
	    AND E.USPLY_PENALTY_FG  = '1'
	    AND B.PROD_CD           NOT LIKE '0%'
	    AND B.ORD_TYP_FG        IN (SELECT DETAIL_CD FROM ALL_CD WHERE GRP_CD = 'USL07') 
	    AND C.GRP_CD            = 'CSA01'  
	    AND B.PROD_CD           = D.PROD_CD
	    AND B.USPLY_BUY_AMT     > 0
	    AND B.CFM_REASON_FG     IS NULL
	    
]]>
	    
	    AND A.SPLY_DY BETWEEN replace(#startDate#,'-','') and replace(#endDate#,'-','')
	    
	  <!--  	<isNotEmpty  property="venCds"  prepend="AND"> 
		      <iterate prepend="A.VEN_CD IN " property="venCds" open="(" close=")" conjunction=","> 
		        #venCds[]# 
		      </iterate> 
		    </isNotEmpty>  -->
		    <isNotEmpty  property="entp_cd"  prepend="AND"> 
		    	A.VEN_CD = #entp_cd#
		   </isNotEmpty>
		   
</select>

<!-- 미납사유등록  -->
<update id="TSC_USPLY_REASON-UPDATE01" parameterClass="map">
/* PEDMUSP0000.TSC_USPLY_REASON-UPDATE01 */
	UPDATE	USPLY_PROD@dl_md_martnis 
	   SET	VEN_REASON_FG = #usp1UD#
		   ,VEN_DETAIL_FG = #usp2UD#
		   ,VEN_CFM_FG = '1'
		   ,VEN_CFM_DT = CURRENT_TIMESTAMP(0)
	 WHERE  ORD_SLIP_NO = #ordnoUD#
	   AND	PROD_CD = #prodUD#
</update>

<!-- 페널티확정 -->
<select id="TSC_PENALTY-SELECT01" parameterClass="map" resultClass="resultClass">
/* PEDMUSP0000.TSC_PENALTY-SELECT01 */
	SELECT	TO_CHAR(TO_DATE(A.SPLY_DY,'yyyymmdd'),'YYYY-MM-DD') SPLY_DY
	       ,A.SRCMK_CD
	       ,A.PROD_NM
	       ,A.PROD_STD
	       ,A.ORD_IPSU
	       ,(SELECT CD_NM FROM TED_CODE WHERE TED_CODE.MAJOR_CD = 'CSA01' AND TED_CODE.MINOR_CD = A.ORD_UNIT) AS ORD_UNIT
	       ,B.STR_NM
	       ,ROUND(NVL(A.USPLY_QTY, 0) / NVL(A.ORD_IPSU, 0) ,0) AS USPLY_QTY
	       ,A.USPLY_BUY_AMT
	       ,C.CD_NM AS MINOR_CD
	       ,B.STR_CD
	
	FROM  TED_USPLY_PROD A, STORE@dl_md_martnis B, TET_CODE C

	WHERE A.STR_CD=B.STR_CD
	AND   A.CFM_DETAIL_FG = C.MINOR_CD
	AND   C.MAJOR_CD = 'USL06' 
	AND   A.CFM_REASON_FG = '1'
	
	  AND A.SPLY_DY between replace(#startDate#,'-','') and replace(#endDate#,'-','')
	  
	      <isNotEmpty  property="venCds"  prepend="AND"> 
		      <iterate prepend="A.VEN_CD IN " property="venCds" open="(" close=")" conjunction=","> 
		        #venCds[]# 
		      </iterate> 
		    </isNotEmpty>
		   
		   <isNotEmpty  property="entp_cd"  prepend="AND"> 
		    	A.VEN_CD = #entp_cd#
		   </isNotEmpty>
		   
		   <isNotEmpty property="storeVal"  prepend="AND"> 
		      <iterate prepend="A.STR_CD IN " property="storeVal" open="(" close=")" conjunction=","> 
		        #storeVal[]# 
		      </iterate> 
		    </isNotEmpty>
	      
</select>

	
</sqlMap>
