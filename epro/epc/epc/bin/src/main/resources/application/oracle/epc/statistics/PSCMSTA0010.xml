<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="PSCMSTA0010">
	<typeAlias alias="pscmsta0010VO" type="com.lottemart.epc.statistics.model.PSCMSTA0010VO"/>
	
	
	<select id="selectToDate" resultClass="dataMap">
	<![CDATA[	
		SELECT TO_CHAR(CURRENT_TIMESTAMP(0),'YYYY-MM-DD')TO_DATE,
			   TO_CHAR(CURRENT_TIMESTAMP(0),'YYYY-MM')||'-'||'01'FIRST_DATE
		FROM DUAL
	]]>
	</select>
	
	
	
	<select id="selectRecipeConEdmSummaryTotal" parameterClass="java.util.HashMap" resultClass="dataMap">
	/* PSCMSTA0010.selectRecipeConEdmSummaryTotal */ 
		
	SELECT 
		      NVL(MAX(DECODE(ORD_RTN_DIVN_CD, '10', CNT)),0) AS ORDER_CNT,          -- 총주문수량
		      NVL(MAX(DECODE(ORD_RTN_DIVN_CD, '10', AMT)),0) AS ORDER_AMT,          -- 총주문금액
		      NVL(MAX(DECODE(ORD_RTN_DIVN_CD, '20', CNT)),0) AS CANCEL_CNT,         -- 취소수량
		      NVL(MAX(DECODE(ORD_RTN_DIVN_CD, '20', AMT)),0) AS CANCEL_AMT,         -- 취소금액 
		      NVL(MAX(DECODE(ORD_RTN_DIVN_CD, '40', CNT)),0) AS REFUND_CNT,        	-- 반품수량
		      NVL(MAX(DECODE(ORD_RTN_DIVN_CD, '40', AMT)),0) AS REFUND_AMT,        	-- 반품금액
		      NVL(MAX(DECODE(ORD_RTN_DIVN_CD, '10', CNT)),0) - 
		      NVL(MAX(DECODE(ORD_RTN_DIVN_CD, '20', CNT)),0) -
		      NVL(MAX(DECODE(ORD_RTN_DIVN_CD, '40', CNT)),0) AS REAL_CNT,        	-- 순주문수량 
		      NVL(MAX(DECODE(ORD_RTN_DIVN_CD, '10', AMT)),0) -
		      NVL(MAX(DECODE(ORD_RTN_DIVN_CD, '20', AMT)),0) - 
		      NVL(MAX(DECODE(ORD_RTN_DIVN_CD, '40', AMT)),0) AS REAL_AMT        	-- 순주문금액
	FROM  
	(
		SELECT 
				CASE 
				     WHEN O.ORD_RTN_DIVN_CD IN ('10', '11') THEN '10'
				     WHEN O.ORD_RTN_DIVN_CD IN ('20', '30') THEN '20'
				     ELSE '40'
				END AS ORD_RTN_DIVN_CD,
				
				COUNT(DISTINCT O.ORDER_ID) AS CNT,
				
				SUM(CASE WHEN OD.ORD_SETL_DIVN_CD = '21' THEN NVL(OD.DPST_AMT, 0) + NVL(OD.PROC_COMM, 0) END) AS AMT
		FROM   
		(
			SELECT 
					O2.ORDER_ID, 
					O2.ORD_RTN_DIVN_CD
			FROM    TOR_ORDER O,
		            TOR_ORDER O2
		    WHERE   O.ORDER_ID = O2.FIRST_ORDER_ID
			AND     O.ORDER_ID IN ( 
									SELECT ORD_BASKET_ID
			                        FROM   TOTSD_CHL_INFW_LOG 
						            WHERE  OTSD_CHL_NO = '00047'
						            AND    SCT_CD      = '0'
						           )
			AND     O2.ORD_RTN_DIVN_CD != '50' 
			AND     O2.ORD_DY BETWEEN #fromDate# AND #toDate#  /* 주문일자 */ 
		) O, TOR_DEMAND OD
		WHERE  O.ORDER_ID = OD.ORDER_ID
		GROUP  BY CASE WHEN O.ORD_RTN_DIVN_CD IN ('10', '11') THEN '10'
		               WHEN O.ORD_RTN_DIVN_CD IN ('20', '30') THEN '20'
		               ELSE '40'
		          END
	) T
	</select>
	
	<select id="selectRecipeConEdmSummaryList" parameterClass="pscmsta0010VO" resultClass="dataMap">
	
	/* PSCMSTA0010.selectRecipeConEdmSummaryList */
	SELECT
            *
    FROM 
    (
        SELECT 
                CEIL(ROWNUM / #recordCountPerPage#  ) PAGE
            , COUNT(*) OVER() TOTAL_COUNT
            , B.*
        FROM 
        (
            SELECT
                    RANK()OVER(ORDER BY O.ORDER_ID DESC) NUM                              -- 순번
                    ,O.ORD_DY                                                             -- 주문일자
                    ,O.FIRST_ORDER_ID                                                     -- 원주문번호
                    ,O.ORDER_ID                                                           -- 주문번호
                    ,(                                                                    
                        SELECT  CD_NM                                                     
                        FROM    TET_CODE A                                                
                        WHERE   A.MAJOR_CD = 'OR002'                                      
                        AND     A.MINOR_CD = O.ORD_STS_CD                                 
                    ) AS STATUS_NM                                                        -- 주문상태
                    ,O.ORD_RTN_DIVN_CD                                                    
                    ,NVL(O.ORDER_ITEM_AMT_SUM,0)           AS ORDER_ITEM_AMT_SUM          -- 주문금액
                    ,NVL(O.TOTAL_DC_AMT_SUM,0)             AS TOTAL_DC_AMT_SUM            -- 할인금액
                    ,NVL(O.DELIVERY_AMT_SUM,0)             AS DELIVERY_AMT_SUM            -- 배송비
                    ,NVL(OD.APPLY_TOT_AMT,0)               AS APPLY_TOT_AMT               -- 결제금액
                    ,NVL(OD.APPLY_POINT_AMT,0)             AS APPLY_POINT_AMT             -- 포인트결제
                    ,NVL(OD.APPLY_COUPON_AMT,0)            AS APPLY_COUPON_AMT            -- 쿠폰결제
                    ,NVL(OD.APPLY_DELIV_COUPON_AMT,0)      AS APPLY_DELIV_COUPON_AMT      -- 배송비쿠폰
            FROM   
            (
                SELECT
                        O.ORD_DY
                       ,O.ORDER_ID
                       ,O.BSKET_DIVN_CD
                       ,O.ORD_RTN_DIVN_CD
                       ,O.FIRST_ORDER_ID
                       ,MIN(O.ORD_STS_CD)                                    AS ORD_STS_CD
                    
                       ,SUM(DECODE(OI.ORD_ITEM_DIVN_CD,'11', 0,
                                                       '12', 0,
                                                       '13', 0,
                                                        OI.ORD_AMT
                                  ) 
                           )                                                 AS ORDER_ITEM_AMT_SUM
                            
                       ,SUM(NVL(OI.DC_AMT, 0) + NVL(OI.CMS_COUPON_DC_AMT,0)
                          	                  + NVL(OI.COUPON_DC_AMT,0)
                                              + NVL(OI.STAFF_DC_AMT, 0)
                            )                                                AS TOTAL_DC_AMT_SUM
                        
                    ,SUM(DECODE(OI.ORD_ITEM_DIVN_CD,'11', OI.ORD_AMT,
                                                    '12', OI.ORD_AMT,
                                                    '13', OI.ORD_AMT,
                                                        0
                                )
                        )                                                AS DELIVERY_AMT_SUM
                FROM   
                (
                    SELECT
                            O2.ORDER_ID, 
                            O2.FIRST_ORDER_ID, 
                            O2.ORD_RTN_DIVN_CD, 
                            O2.BSKET_DIVN_CD, 
                            O2.ORD_DY, 
                            O.ORD_STS_CD
                    FROM    TOR_ORDER O,
                            TOR_ORDER O2
                    WHERE   O.ORDER_ID = O2.FIRST_ORDER_ID
                    AND     O.ORDER_ID IN ( 
                                            SELECT ORD_BASKET_ID
                                            FROM   TOTSD_CHL_INFW_LOG                       -- 외부유입채널 로그
                                            WHERE  OTSD_CHL_NO = '00047'
                                            AND    SCT_CD      = '0'
                                        )
                                    AND    O2.ORD_RTN_DIVN_CD != '50'
                                    AND    O2.ORD_DY BETWEEN #fromDate# AND #toDate#        -- 주문일자
    
    
                ) O, TOR_ORDER_ITEM OI
                WHERE  O.ORDER_ID = OI.ORDER_ID
                AND   (OI.PROD_CD IN (
                                        SELECT  DISTINCT PROD_CD 
                                        FROM    TCA_RCP_RECOM_PROD
                                    ) 
                    OR 
                    OI.ORD_ITEM_DIVN_CD IN ('11','12','13')
                    )
                GROUP  BY O.ORD_DY, O.ORDER_ID, O.ORD_RTN_DIVN_CD, O.BSKET_DIVN_CD, O.FIRST_ORDER_ID
            ) O,
            (
                SELECT
                        O.ORDER_ID
                    ,SUM(CASE WHEN OD.SETL_TYPE_CD IN ('01', '02','06','07','08','09','10','12') THEN NVL(OD.DPST_AMT, 0) + NVL(OD.PROC_COMM, 0) END) APPLY_TOT_AMT
                    ,SUM(CASE WHEN OD.SETL_TYPE_CD = '03' THEN NVL(OD.DPST_AMT, 0) + NVL(OD.PROC_COMM, 0) END) APPLY_COUPON_AMT
                    ,SUM(CASE WHEN OD.SETL_TYPE_CD = '04' THEN NVL(OD.DPST_AMT, 0) + NVL(OD.PROC_COMM, 0) END) APPLY_POINT_AMT
                    ,SUM(CASE WHEN OD.SETL_TYPE_CD = '05' THEN NVL(OD.DPST_AMT, 0) + NVL(OD.PROC_COMM, 0) END) APPLY_DELIV_COUPON_AMT
                FROM   
                (
                    SELECT
                            O2.ORDER_ID, 
                            O2.ORD_RTN_DIVN_CD, 
                            O2.BSKET_DIVN_CD, 
                            O2.ORD_DY
                    FROM    TOR_ORDER O
                        ,TOR_ORDER O2
                    WHERE   O.ORDER_ID = O2.FIRST_ORDER_ID
                    AND     O.ORDER_ID IN( 
                                            SELECT ORD_BASKET_ID
                                            FROM   TOTSD_CHL_INFW_LOG
                                            WHERE  OTSD_CHL_NO = '00047'
                                            AND    SCT_CD      = '0'
                                        )
                    AND     O2.ORD_RTN_DIVN_CD != '50'
                    AND     O2.ORD_DY BETWEEN #fromDate# AND #toDate#                               -- 주문일자
                ) O, TOR_DEMAND OD
                WHERE  O.ORDER_ID = OD.ORDER_ID
                GROUP  BY O.ORDER_ID
            ) OD
            WHERE  O.ORDER_ID = OD.ORDER_ID
        ) B
    )
    WHERE PAGE = #pageIndex#
	</select>
	
	
	
	
	<select id="selectRecipeConEdmSummaryListExcel" parameterClass="pscmsta0010VO" resultClass="dataMap">
	/* PSCMSTA0010.selectRecipeConEdmSummaryListExcel */ 
	
    SELECT
            RANK()OVER(ORDER BY O.ORDER_ID DESC) NUM                             -- 순번
            ,O.ORD_DY                                                             -- 주문일자
            ,O.FIRST_ORDER_ID                                                     -- 원주문번호
            ,O.ORDER_ID                                                           -- 주문번호
            ,(                                                                    
                SELECT  CD_NM                                                     
                FROM    TET_CODE A                                                
                WHERE   A.MAJOR_CD = 'OR002'                                      
                AND     A.MINOR_CD = O.ORD_STS_CD                                 
            ) AS STATUS_NM                                                       -- 주문상태
            ,O.ORD_RTN_DIVN_CD                                                    
            ,NVL(O.ORDER_ITEM_AMT_SUM,0)           AS ORDER_ITEM_AMT_SUM          -- 주문금액
            ,NVL(O.TOTAL_DC_AMT_SUM,0)             AS TOTAL_DC_AMT_SUM            -- 할인금액
            ,NVL(O.DELIVERY_AMT_SUM,0)             AS DELIVERY_AMT_SUM            -- 배송비
            ,NVL(OD.APPLY_TOT_AMT,0)               AS APPLY_TOT_AMT               -- 결제금액
            ,NVL(OD.APPLY_POINT_AMT,0)             AS APPLY_POINT_AMT             -- 포인트결제
            ,NVL(OD.APPLY_COUPON_AMT,0)            AS APPLY_COUPON_AMT            -- 쿠폰결제
            ,NVL(OD.APPLY_DELIV_COUPON_AMT,0)      AS APPLY_DELIV_COUPON_AMT      -- 배송비쿠폰
    FROM   
    (
        SELECT
                O.ORD_DY
            ,O.ORDER_ID
            ,O.BSKET_DIVN_CD
            ,O.ORD_RTN_DIVN_CD
            ,O.FIRST_ORDER_ID
            ,MIN(O.ORD_STS_CD)                                   AS ORD_STS_CD
            
            ,SUM(DECODE(OI.ORD_ITEM_DIVN_CD,'11', 0,
                                            '12', 0,
                                            '13', 0,
                                                OI.ORD_AMT
                        ) 
                    )                                               AS ORDER_ITEM_AMT_SUM
                    
            ,SUM(NVL(OI.DC_AMT, 0) + NVL(OI.CMS_COUPON_DC_AMT,0)
                                    + NVL(OI.COUPON_DC_AMT,0)
                                    + NVL(OI.STAFF_DC_AMT, 0)
                )                                                AS TOTAL_DC_AMT_SUM
                
            ,SUM(DECODE(OI.ORD_ITEM_DIVN_CD,'11', OI.ORD_AMT,
                                            '12', OI.ORD_AMT,
                                            '13', OI.ORD_AMT,
                                                0
                        )
                )                                                AS DELIVERY_AMT_SUM
        FROM   
        (
            SELECT
                    O2.ORDER_ID, 
                    O2.FIRST_ORDER_ID, 
                    O2.ORD_RTN_DIVN_CD, 
                    O2.BSKET_DIVN_CD, 
                    O2.ORD_DY, 
                    O.ORD_STS_CD
            FROM    TOR_ORDER O,
                    TOR_ORDER O2
            WHERE   O.ORDER_ID = O2.FIRST_ORDER_ID
            AND     O.ORDER_ID IN ( 
                                    SELECT ORD_BASKET_ID
                                    FROM   TOTSD_CHL_INFW_LOG                       -- 외부유입채널 로그
                                    WHERE  OTSD_CHL_NO = '00047'					-- SM093:채널 유형 분석 코드  [00047:레시피]
                                    AND    SCT_CD      = '0'
                                )
                            AND    O2.ORD_RTN_DIVN_CD != '50'
                            AND    O2.ORD_DY BETWEEN #fromDate# AND #toDate#        -- 주문일자
    
    
        ) O, TOR_ORDER_ITEM OI
        WHERE  O.ORDER_ID = OI.ORDER_ID
        -- 2015.12.18 by kmlee 리스트에서는 [레시피 추천상품]테이블에 있는 상품 주문일때만 출력하고 있는데,
        -- 상단 summary에서는  [레시피추천상품]테이블을 참조하지 않고 있어서...
        -- 유입경로가 '레시피'이면서 주문상품이 [레시피추천상품]에 없으면, summary 내용과 list 내용이 달라짐. 
        AND   (OI.PROD_CD IN (
                                SELECT  DISTINCT PROD_CD 
                                FROM    TCA_RCP_RECOM_PROD							-- [레시피추천상품]
                            ) 
            OR 
            OI.ORD_ITEM_DIVN_CD IN ('11','12','13')
            )
        GROUP  BY O.ORD_DY, O.ORDER_ID, O.ORD_RTN_DIVN_CD, O.BSKET_DIVN_CD, O.FIRST_ORDER_ID
    ) O,
    (
        SELECT
                O.ORDER_ID
            ,SUM(CASE WHEN OD.SETL_TYPE_CD IN ('01', '02','06','07','08','09','10','12') THEN NVL(OD.DPST_AMT, 0) + NVL(OD.PROC_COMM, 0) END) APPLY_TOT_AMT
            ,SUM(CASE WHEN OD.SETL_TYPE_CD = '03' THEN NVL(OD.DPST_AMT, 0) + NVL(OD.PROC_COMM, 0) END) APPLY_COUPON_AMT
            ,SUM(CASE WHEN OD.SETL_TYPE_CD = '04' THEN NVL(OD.DPST_AMT, 0) + NVL(OD.PROC_COMM, 0) END) APPLY_POINT_AMT
            ,SUM(CASE WHEN OD.SETL_TYPE_CD = '05' THEN NVL(OD.DPST_AMT, 0) + NVL(OD.PROC_COMM, 0) END) APPLY_DELIV_COUPON_AMT
        FROM   
        (
            SELECT
                    O2.ORDER_ID, 
                    O2.ORD_RTN_DIVN_CD, 
                    O2.BSKET_DIVN_CD, 
                    O2.ORD_DY
            FROM    TOR_ORDER O
                ,TOR_ORDER O2
            WHERE   O.ORDER_ID = O2.FIRST_ORDER_ID
            AND     O.ORDER_ID IN( 
                                    SELECT ORD_BASKET_ID
                                    FROM   TOTSD_CHL_INFW_LOG
                                    WHERE  OTSD_CHL_NO = '00047'
                                    AND    SCT_CD      = '0'
                                )
            AND     O2.ORD_RTN_DIVN_CD != '50'
            AND     O2.ORD_DY BETWEEN #fromDate# AND #toDate#                               -- 주문일자
        ) O, TOR_DEMAND OD
        WHERE  O.ORDER_ID = OD.ORDER_ID
        GROUP  BY O.ORDER_ID
    ) OD
    WHERE  O.ORDER_ID = OD.ORDER_ID
  
		     
	</select>
	
</sqlMap>