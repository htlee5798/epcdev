<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="notice">

	<typeAlias  alias="BaseMap" type="lcn.module.framework.ibatis.BaseMap"/>
	<typeAlias  alias="NoticeVO" type="com.lottemart.common.notice.model.NoticeVO"/>
	
	<select id="mainNoticeList"  resultClass="NoticeVO" >
 		SELECT * FROM
		(
			select  rank()over(order by board_seq desc) num  
			       ,board_seq as boardseq
			       ,substrb(title,1,50)||'...' as title
			       ,atch_file_id as atchfileid
			from   tbo_board bo
			where  board_divn_cd  ='100'
			and    del_yn         = 'N'
			and    pbl_yn         = 'Y'
			and    ntce_start_dy  <![CDATA[ <= ]]>  to_char(CURRENT_TIMESTAMP(0),'yyyyMMddhh')  
			and    ntce_end_dy    <![CDATA[ >= ]]> to_char(CURRENT_TIMESTAMP(0),'yyyyMMddhh') 
			AND    NVL(LET_3_REF,'99') IN('99',#sysDivnCd#) 
			and  ( (#strCd#  = '999')
			    or (#strCd# != '999' and exists(select '1' from tbo_board_category bc1
			                                       where bc1.board_seq   = bo.board_seq
			                                       and   bc1.category_id = #strCd#
			                                       union all
			                                       select '1' from dual
			                                       where 'true' = (select decode(count(*),0,'true','false') as chk
			                                                       from   tbo_board_category bc2
			                                                       where  bc2.board_seq   = bo.board_seq)
			                                       )))
		 )   
		WHERE  num BETWEEN 1 AND 3  
 	</select>
 	
 	<select id="selectAllStoreList" resultClass="NoticeVO">
    	
    	SELECT	S.STR_CD strCd, S.STR_NM strName, (SELECT 'Y' FROM TBO_BOARD_CATEGORY A WHERE A.CATEGORY_ID = S.STR_CD AND A.BOARD_SEQ = #boardSeq#) chkStrCd
		  FROM	TST_STORE S
		 WHERE	S.STR_CD != '999' 
		   AND 	S.ONLINE_YN='Y'  
		 ORDER  BY ORDER_SEQ ASC, STR_NM
    </select>
    
    <select id="selectNoticeView" resultClass="NoticeVO">
		 
		 SELECT  BOARD_SEQ boardSeq
		        ,SUBSTR(NTCE_START_DY, 0, 4) ||'-'|| SUBSTR(NTCE_START_DY, 5, 2) ||'-'|| SUBSTR(NTCE_START_DY, 7, 2) startDt
		        ,SUBSTR(NTCE_END_DY, 0, 4) ||'-'|| SUBSTR(NTCE_END_DY, 5, 2) ||'-'|| SUBSTR(NTCE_END_DY, 7, 2) endDt
		        ,SUBSTR(NTCE_START_DY,9) AS startTime
		        ,SUBSTR(NTCE_END_DY,9) AS endTime
		        ,TITLE AS title 
		        ,CONTENT AS content
		        ,PBL_YN AS pblYN
		        ,VIEW_CNT AS viewCnt
		FROM    TBO_BOARD
		WHERE   BOARD_SEQ = #boardSeq#
		AND     BOARD_DIVN_CD = '100'
	</select>
	<update id="updateViewCnt">
		
		UPDATE TBO_BOARD  
		SET VIEW_CNT = VIEW_CNT + 1
		WHERE BOARD_SEQ = #boardSeq#
	</update>
	
	<!-- 팝업공지 목록 조회 -->
	<select id="selectPopupNoticeList" resultClass="NoticeVo">
	<![CDATA[
	/* notice.selectPopupNoticeList */
	SELECT
           BOARD_SEQ as boardSeq, TITLE AS title, CONTENT AS content, ATCH_FILE_ID AS atchFileId
    FROM   (SELECT 
    			   BO.BOARD_SEQ
                  ,BO.TITLE
                  ,BO.CONTENT
                  ,BO.ATCH_FILE_ID
            FROM   TBO_BOARD BO
            WHERE  BO.BOARD_DIVN_CD = '100'
            AND    BO.DEL_YN        = 'N'
            AND    BO.PBL_YN        = 'Y'
            AND    NTCE_START_DY  <=  TO_CHAR(CURRENT_TIMESTAMP(0),'YYYYMMDDHH')  
            AND    NTCE_END_DY    >=  TO_CHAR(CURRENT_TIMESTAMP(0),'YYYYMMDDHH')
            AND    NVL(LET_1_REF,'N' ) = 'Y'
            AND    NVL(LET_3_REF,'99') IN('99',#sysDivnCd#) 
            AND  ( (#strCd#  = '999')
                OR (#strCd# != '999' AND EXISTS(SELECT '1' FROM TBO_BOARD_CATEGORY BC1
                                                   WHERE BC1.BOARD_SEQ   = BO.BOARD_SEQ
                                                   AND   BC1.CATEGORY_ID = #strCd#
                                                   UNION ALL
                                                   SELECT '1' FROM DUAL
                                                   WHERE 'TRUE' = (SELECT DECODE(COUNT(*),0,'TRUE','FALSE') AS CHK
                                                                   FROM   TBO_BOARD_CATEGORY BC2
                                                                   WHERE  BC2.BOARD_SEQ   = BO.BOARD_SEQ)
                                                   )
                   ))
            ORDER BY BOARD_SEQ DESC
           ) V
    WHERE ROWNUM <= 3
    ]]>
	</select>
</sqlMap>
